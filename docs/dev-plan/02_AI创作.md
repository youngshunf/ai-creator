# 02 AI 创作开发计划

> 需求来源: `docs/14-MVP需求规格.md` 2.1 AI 创作模块
> 参考文档: `docs/05-Agent-Runtime.md`, `docs/07-AI工作流.md`

## 一、需求概述

实现完整的文章创作工作流，降低创作门槛。

| 需求ID | 功能 | 优先级 |
|--------|------|--------|
| F-MVP-001 | 极简选题 | P0 |
| F-MVP-002 | AI 智能写作 | P0 |
| F-MVP-003 | 内容编辑 | P0 |
| F-MVP-004 | AI 配图生成 | P0 |
| F-MVP-005 | 智能排版 | P1 |

---

## 二、Agent 工作流设计

### 2.1 Graph 定义

基于 `docs/07-AI工作流.md` 的 LangGraph 设计。

**文件**: `agent-definitions/content-creation.yaml`

```yaml
name: content-creation
description: 内容创作工作流

state:
  # 输入
  topic: string
  platform: string
  style: string
  project_context:
    brand_name: string
    brand_tone: string
    topics: list[string]
    
  # 中间状态
  stage: enum[research, outline, draft, polish, image, complete]
  topic_suggestions: list[string]
  outline: string
  draft: string
  polished_content: string
  images: list[string]
  
  # 输出
  final_content: string
  final_title: string

nodes:
  - name: topic_recommend
    tool: llm_generate
    description: 根据主题推荐选题
    
  - name: generate_outline
    tool: llm_generate
    description: 生成内容大纲
    
  - name: write_draft
    tool: llm_generate
    description: 撰写初稿
    
  - name: polish_content
    tool: llm_generate
    description: 润色内容
    
  - name: generate_images
    tool: image_gen
    description: 生成配图

edges:
  - from: START
    to: topic_recommend
  - from: topic_recommend
    to: generate_outline
    condition: user_confirmed_topic
  - from: generate_outline
    to: write_draft
  - from: write_draft
    to: polish_content
  - from: polish_content
    to: generate_images
  - from: generate_images
    to: END
```

### 2.2 工作流实现

**文件**: `packages/agent-core/src/agent_core/workflows/content_creation/`

```text
content_creation/
├── __init__.py
├── state.py          # 状态定义
├── graph.py          # Graph 构建
├── nodes.py          # 节点实现
└── prompts.py        # Prompt 模板
```

### 2.3 Prompt 设计

**文件**: `packages/agent-core/src/agent_core/workflows/content_creation/prompts.py`

```python
TOPIC_RECOMMEND_PROMPT = """
你是一个自媒体选题专家。根据用户输入的主题和项目上下文，推荐 5-10 个热门选题。

项目信息:
- 品牌: {brand_name}
- 调性: {brand_tone}
- 关注话题: {topics}

用户主题: {topic}
目标平台: {platform}

请输出 JSON 格式的选题列表:
[{{"title": "选题标题", "reason": "推荐理由", "heat": 85}}]
"""

WRITE_DRAFT_PROMPT = """
你是一个资深自媒体写手。根据以下大纲撰写完整内容。

品牌: {brand_name}
品牌调性: {brand_tone}
平台: {platform}
风格: {style}

大纲:
{outline}

请撰写完整内容，包括吸引人的标题。
"""
```

---

## 三、云端 API 开发

### 3.1 Agent 执行 API

**文件**: `services/cloud-backend/backend/app/api/v1/agent.py`

| Method | Path | 描述 |
|--------|------|------|
| POST | `/api/v1/agent/run` | 启动 Agent 执行 |
| GET | `/api/v1/agent/run/{run_id}` | 查询执行状态 |
| GET | `/api/v1/agent/run/{run_id}/events` | SSE 事件流 |
| POST | `/api/v1/agent/run/{run_id}/cancel` | 取消执行 |

### 3.2 内容存储 API

**文件**: `services/cloud-backend/backend/app/api/v1/contents.py`

| Method | Path | 描述 |
|--------|------|------|
| POST | `/api/v1/contents` | 创建内容 |
| GET | `/api/v1/contents` | 获取内容列表 |
| GET | `/api/v1/contents/{id}` | 获取内容详情 |
| PUT | `/api/v1/contents/{id}` | 更新内容 |
| DELETE | `/api/v1/contents/{id}` | 删除内容 |

---

## 四、桌面端开发

### 4.1 Sidecar 集成

**文件**: `apps/sidecar/src/sidecar/workflows/content_creation.py`

```python
from agent_core.workflows.content_creation import ContentCreationWorkflow

@server.register("agent.content_creation")
async def run_content_creation(
    topic: str,
    platform: str,
    style: str,
    project_context: dict,
) -> AsyncIterator[dict]:
    """执行内容创作工作流"""
    workflow = ContentCreationWorkflow()
    async for event in workflow.run_stream(...):
        yield event.to_dict()
```

### 4.2 前端 UI

#### 4.2.1 创作中心页面

**文件**: `apps/desktop/src/routes/creation/index.tsx` (已存在)

增强功能:
- 选题推荐面板
- AI 生成进度展示
- 流式输出显示

#### 4.2.2 AI 写作面板

**文件**: `apps/desktop/src/components/editor/AIWritingPanel.tsx` (已存在)

增强功能:
- 风格选择 (小红书风/公众号风/知乎风)
- 项目上下文注入
- 生成历史记录

#### 4.2.3 配图生成

**文件**: `apps/desktop/src/components/creation/ImageGenerator.tsx` (新增)

- 根据内容自动生成图片描述
- 调用 ComfyUI API 生成图片
- 图片预览和选择

### 4.3 Hooks

**文件**: `apps/desktop/src/hooks/useAICreation.ts` (新增)

```typescript
export function useAICreation() {
  const runCreation = async (params: CreationParams) => {
    // 1. 获取当前项目上下文
    const project = useProjectStore.getState().currentProject;
    
    // 2. 调用 Sidecar 执行工作流
    const result = await invoke('run_content_creation', {
      ...params,
      project_context: {
        brand_name: project.brand_name,
        brand_tone: project.brand_tone,
        topics: project.topics,
      }
    });
    
    return result;
  };
  
  return { runCreation };
}
```

---

## 五、验证计划

### 5.1 单元测试

**Agent 工作流测试**:
```bash
cd packages/agent-core
uv run pytest tests/test_content_creation.py -v
```

### 5.2 手动测试

1. **选题推荐**:
   - 在创作中心输入关键词 "夏日穿搭"
   - 选择平台 "小红书"
   - 点击"获取选题推荐"
   - 验证返回 5-10 个选题

2. **AI 写作**:
   - 选择一个选题
   - 点击"一键生成"
   - 验证应先生成大纲，再生成正文
   - 验证内容符合项目品牌调性

3. **配图生成**:
   - 内容生成后，点击"生成配图"
   - 验证生成 1-3 张图片
   - 图片应与内容主题相关

---

## 六、交付物清单

- [ ] `agent-definitions/content-creation.yaml`
- [ ] `packages/agent-core/src/agent_core/workflows/content_creation/`
- [ ] `services/cloud-backend/backend/app/api/v1/agent.py`
- [ ] `services/cloud-backend/backend/app/api/v1/contents.py`
- [ ] `apps/sidecar/src/sidecar/workflows/content_creation.py`
- [ ] `apps/desktop/src/components/creation/ImageGenerator.tsx`
- [ ] `apps/desktop/src/hooks/useAICreation.ts`
