# 平台适配器整合与配置外部化方案

## 1. 目标

- 将 `apps/sidecar/src/sidecar/platforms/` 和 `packages/agent-core/src/agent_core/platforms/` 整合为单一实现
- 以 sidecar 版本为基础（已验证可工作），迁移到 agent-core
- 将平台配置（URL、选择器、内容限制）外部化到 YAML 文件
- 确保云端和桌面端具有相同的能力

## 2. 现状分析

### 2.1 代码重复

| 位置                            | 基类大小 | 平台数 | 状态      |
| ------------------------------- | -------- | ------ | --------- |
| `apps/sidecar/platforms`        | 6KB      | 4个    | ✅ 工作中 |
| `packages/agent-core/platforms` | 11KB     | 5个    | ⚠️ 较旧   |

### 2.2 配置硬编码位置

- 类属性: `platform_name`, `login_url`, `platform_url`
- `spec` 属性 / `get_content_constraints()`: 内容限制
- `SELECTORS` 字典: CSS/XPath 选择器
- `account_sync.py`: `PLATFORM_URLS`, `PROFILE_URL_TEMPLATES`

### 2.3 接口差异

- sidecar: `ContentSpec`, `AdaptedContent`, `LoginResult`, `UserProfile`
- agent-core: `ContentConstraints`, `PublishContent`, `PublishResult`

## 3. 目标架构

```warp-runnable-command
packages/agent-core/src/agent_core/platforms/
├── __init__.py                    # 统一导出
├── base.py                        # 统一基类 (合并两版本优点)
├── models.py                      # 数据模型 (Pydantic)
├── registry.py                    # 平台注册表
├── config/                        # 🆕 配置模块
│   ├── __init__.py
│   ├── schema.py                  # 配置 Schema
│   ├── loader.py                  # 配置加载器 (YAML + DB)
│   └── defaults/                  # 默认配置
│       ├── xiaohongshu.yaml
│       ├── douyin.yaml
│       ├── bilibili.yaml
│       ├── wechat.yaml
│       └── weibo.yaml
├── adapters/                      # 平台适配器实现
│   ├── __init__.py
│   ├── xiaohongshu.py
│   ├── douyin.py
│   ├── bilibili.py
│   ├── wechat.py
│   └── weibo.py
└── utils.py                       # 工具函数
apps/sidecar/src/sidecar/platforms/  # 🗑️ 删除，改为导入 agent-core
```

## 4. 配置 Schema 设计

### 4.1 YAML 配置示例 (`xiaohongshu.yaml`)

```yaml
platform:
  name: xiaohongshu
  display_name: 小红书
  type: xiaohongshu
  icon: xiaohongshu.svg
urls:
  home: https://www.xiaohongshu.com
  login: https://www.xiaohongshu.com/login
  creator: https://creator.xiaohongshu.com
  publish: https://creator.xiaohongshu.com/publish/publish
  profile_template: https://www.xiaohongshu.com/user/profile/{user_id}
constraints:
  title:
    max_length: 20
    min_length: 0
    required: false
  content:
    max_length: 1000
    min_length: 5
  images:
    max_count: 18
    min_count: 0
    max_size_mb: 20
    formats: [jpg, jpeg, png, webp]
    aspect_ratio: "3:4"
  video:
    max_duration: 600
    max_size_mb: 500
    formats: [mp4, mov]
  hashtags:
    max_count: 10
  mentions:
    max_count: 10
  features:
    allow_external_links: false
    allow_internal_links: true
    location_supported: true
    schedule_supported: true
selectors:
  login_check: 'div[class*="user-info"], div[class*="creator-info"]'
  publish_btn: 'div[class*="publish-btn"], button:has-text("发布笔记")'
  upload_image: 'input[type="file"][accept*="image"]'
  upload_video: 'input[type="file"][accept*="video"]'
  title_input: 'input[placeholder*="标题"]'
  content_input: 'div[class*="content"] div[contenteditable="true"], .ql-editor'
  tag_input: 'input[placeholder*="话题"]'
  submit_btn: 'button:has-text("发布"), button[class*="submit"]'
  success_indicator: 'div:has-text("发布成功")'
login_detection:
  cookie_keys: [customerClientId, web_session]
  local_storage_keys: [USER_INFO, USER_INFO_FOR_BIZ]
  url_patterns:
    logged_in: []
    logged_out: ["/login"]
  user_id_extraction:
    - type: local_storage_key_prefix
      pattern: "xhs-pc-search-history-"
    - type: cookie
      key: customerClientId
version: "1.0"
updated_at: "2026-01-22"
```

### 4.2 Pydantic Schema (`schema.py`)

```python
from pydantic import BaseModel
from typing import Optional, List
class PlatformInfo(BaseModel):
    name: str
    display_name: str
    type: str
    icon: Optional[str] = None
class PlatformUrls(BaseModel):
    home: str
    login: str
    creator: Optional[str] = None
    publish: str
    profile_template: Optional[str] = None
class ContentLimits(BaseModel):
    max_length: int
    min_length: int = 0
    required: bool = False
class ImageConstraints(BaseModel):
    max_count: int = 9
    min_count: int = 0
    max_size_mb: float = 20.0
    formats: List[str] = ["jpg", "jpeg", "png"]
    aspect_ratio: Optional[str] = None
class VideoConstraints(BaseModel):
    max_duration: int = 600
    max_size_mb: float = 500.0
    formats: List[str] = ["mp4", "mov"]
class PlatformConstraints(BaseModel):
    title: ContentLimits
    content: ContentLimits
    images: ImageConstraints
    video: VideoConstraints
    hashtags: ContentLimits
    mentions: ContentLimits
    features: dict
class PlatformSelectors(BaseModel):
    login_check: str
    publish_btn: str
    upload_image: str
    upload_video: Optional[str] = None
    title_input: str
    content_input: str
    tag_input: Optional[str] = None
    submit_btn: str
    success_indicator: str
class LoginDetection(BaseModel):
    cookie_keys: List[str]
    local_storage_keys: List[str]
    url_patterns: dict
    user_id_extraction: List[dict]
class PlatformConfig(BaseModel):
    platform: PlatformInfo
    urls: PlatformUrls
    constraints: PlatformConstraints
    selectors: PlatformSelectors
    login_detection: LoginDetection
    version: str = "1.0"
    updated_at: Optional[str] = None
```

## 5. 实施步骤

### Phase 1: 配置基础设施 (Day 1-2)

**目标**: 创建配置模块，不影响现有功能
**步骤**:

1. 在 `agent-core/platforms/` 下创建 `config/` 目录
2. 实现 `schema.py` (Pydantic 模型)
3. 实现 `loader.py` (YAML 加载器)
4. 创建 5 个平台的默认 YAML 配置文件
5. 编写配置加载的单元测试
   **产出**:

- `packages/agent-core/src/agent_core/platforms/config/`
- 5 个平台配置 YAML 文件
- 配置加载测试

### Phase 2: 统一数据模型 (Day 3-4)

**目标**: 合并两套数据模型，保持向后兼容
**步骤**:

1. 创建 `models.py`，合并 `ContentSpec`/`ContentConstraints` 等
2. 提供兼容别名 (type aliases)
3. 更新 `base.py`，使用新模型
4. 编写模型转换测试
   **关键决策**:

- 使用 sidecar 版本的命名风格 (`ContentSpec`, `AdaptedContent`)
- 添加 agent-core 版本的额外字段 (`allowed_image_formats` 等)
- 提供 `to_constraints()` / `from_constraints()` 转换方法

### Phase 3: 重构基类 (Day 5-6)

**目标**: 创建统一的基类，从配置加载元数据
**步骤**:

1. 重构 `base.py`，添加 `__init__(config: PlatformConfig)` 构造函数
2. `spec` 属性从 `config.constraints` 动态生成
3. 选择器从 `config.selectors` 获取
4. URL 从 `config.urls` 获取
5. 保留 `adapt_content()`, `check_login_status()` 等方法签名
6. 添加 `get_selector(name: str)` 辅助方法
   **新基类结构**:

```python
class PlatformAdapter(ABC):
    def __init__(self, config: PlatformConfig = None):
        if config is None:
            config = ConfigLoader.load(self.__class__.platform_name)
        self._config = config
    @property
    def platform_name(self) -> str:
        return self._config.platform.name
    @property
    def spec(self) -> ContentSpec:
        return ContentSpec.from_config(self._config.constraints)
    def get_selector(self, name: str) -> str:
        return getattr(self._config.selectors, name)
```

### Phase 4: 迁移平台适配器 (Day 7-10)

**目标**: 将 sidecar 版本迁移到 agent-core
**步骤** (每个平台):

1. 复制 sidecar 版本到 `agent-core/platforms/adapters/`
2. 移除硬编码配置，改为从 `self._config` 读取
3. 更新 import 路径
4. 运行测试验证
5. 删除 agent-core 旧版本
   **迁移顺序**:
6. 小红书 (最完整，作为模板)
7. 抖音
8. B站
9. 微信
10. 微博

### Phase 5: 更新 Sidecar 引用 (Day 11-12)

**目标**: Sidecar 改为导入 agent-core
**步骤**:

1. 更新 `apps/sidecar/src/sidecar/main.py` 的 import
2. 更新 `apps/sidecar/src/sidecar/services/account_sync.py`
3. 删除 `apps/sidecar/src/sidecar/platforms/` 目录
4. 更新 sidecar 的 `pyproject.toml` 依赖
5. 端到端测试
   **兼容层** (如需要):

```python
# apps/sidecar/src/sidecar/platforms/__init__.py (过渡期)
from agent_core.platforms import (
    PlatformAdapter,
    ContentSpec as AdaptedContent,  # 别名
    get_adapter,
    PLATFORM_ADAPTERS,
)
```

### Phase 6: 云端集成 (Day 13-14)

**目标**: 云端后端使用相同的平台适配器
**步骤**:

1. 在 `cloud-backend` 添加 `agent-core` 依赖
2. 创建 `CloudBrowserPublishTool` 使用 agent-core 适配器
3. 配置浏览器池与适配器集成
4. 测试云端发布流程

### Phase 7: 数据库配置支持 (可选, Day 15+)

**目标**: 支持从数据库加载配置，实现热更新
**步骤**:

1. 扩展 `loader.py` 支持数据库源
2. 创建 `platform_configs` 表
3. 实现配置缓存和失效机制
4. 添加管理后台配置编辑界面

## 6. 测试策略

### 6.1 单元测试

- 配置加载测试
- Schema 验证测试
- 内容适配测试
- 登录检测测试

### 6.2 集成测试

- 浏览器会话测试 (headless)
- 凭证保存/加载测试

### 6.3 端到端测试

- 登录流程 (手动)
- 发布流程 (手动)

## 7. 回滚计划

**Phase 1-4**: 不影响现有功能，可随时停止
**Phase 5**: 保留 sidecar/platforms 备份，import 失败时快速恢复

```warp-runnable-command
# 回滚命令
git checkout HEAD~1 -- apps/sidecar/src/sidecar/platforms/
```

## 8. 风险与缓解

| 风险                 | 影响         | 缓解措施                  |
| -------------------- | ------------ | ------------------------- |
| 选择器失效           | 发布失败     | YAML 可热更新，无需发版   |
| 配置解析错误         | 服务启动失败 | 严格 Schema 验证 + 默认值 |
| 云端适配器行为不一致 | 功能差异     | 统一代码，统一测试        |
| 迁移遗漏             | 功能缺失     | 对比测试，逐平台验证      |

## 9. 时间线

| 阶段                  | 天数   | 里程碑             |
| --------------------- | ------ | ------------------ |
| Phase 1: 配置基础设施 | 2      | 配置模块可用       |
| Phase 2: 统一数据模型 | 2      | 数据模型统一       |
| Phase 3: 重构基类     | 2      | 基类从配置加载     |
| Phase 4: 迁移适配器   | 4      | 所有适配器迁移完成 |
| Phase 5: 更新 Sidecar | 2      | Sidecar 使用新代码 |
| Phase 6: 云端集成     | 2      | 云端使用相同适配器 |
| **总计**              | **14** | 整合完成           |
