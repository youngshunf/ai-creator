# 03 账号管理开发计划

> 需求来源: `docs/14-MVP需求规格.md` 2.2 平台账号管理
> 参考文档: `docs/02-桌面端设计.md`, `docs/01-系统架构.md` (凭证三轨制)

## 一、需求概述

构建多平台分发的基础设施，支持主流平台账号的添加、状态监控与管理。

| 需求ID | 功能 | 优先级 |
|--------|------|--------|
| F-MVP-010 | 账号添加 | P0 |
| F-MVP-011 | 账号列表 | P0 |
| F-MVP-012 | 状态监控 | P0 |
| F-MVP-013 | 账号删除 | P1 |

---

## 二、云端 API 开发

### 2.1 数据模型

**文件**: `services/cloud-backend/backend/app/models/platform_account.py`

```python
class PlatformAccount(Base):
    __tablename__ = "platform_accounts"
    
    id: Mapped[UUID] = mapped_column(primary_key=True)
    user_id: Mapped[UUID] = mapped_column(ForeignKey("users.id"))
    project_id: Mapped[UUID] = mapped_column(ForeignKey("projects.id"))
    
    platform: Mapped[str]  # xiaohongshu, douyin, wechat_mp
    account_id: Mapped[str]  # 平台用户ID
    account_name: Mapped[str | None]
    avatar_url: Mapped[str | None]
    
    is_active: Mapped[bool] = mapped_column(default=True)
    session_valid: Mapped[bool] = mapped_column(default=True)
    last_session_check: Mapped[datetime | None]
    
    # 统计数据
    followers_count: Mapped[int] = mapped_column(default=0)
    following_count: Mapped[int] = mapped_column(default=0)
    posts_count: Mapped[int] = mapped_column(default=0)
    
    metadata: Mapped[dict] = mapped_column(JSONB, default=dict)
    is_deleted: Mapped[bool] = mapped_column(default=False)
    
    # 同步元数据
    server_version: Mapped[int] = mapped_column(default=0)
    
    created_at: Mapped[datetime]
    updated_at: Mapped[datetime]
```

### 2.2 API 端点

**文件**: `services/cloud-backend/backend/app/api/v1/accounts.py`

| Method | Path | 描述 |
|--------|------|------|
| POST | `/api/v1/accounts` | 添加账号 |
| GET | `/api/v1/accounts` | 获取账号列表 |
| GET | `/api/v1/accounts/{id}` | 获取账号详情 |
| DELETE | `/api/v1/accounts/{id}` | 删除账号 |
| POST | `/api/v1/accounts/{id}/check-status` | 检查状态 |
| POST | `/api/v1/accounts/{id}/refresh` | 刷新登录 |

---

## 三、桌面端开发

### 3.1 Playwright 浏览器自动化

**文件**: `apps/sidecar/src/sidecar/automation/browser/`

```text
browser/
├── __init__.py
├── manager.py         # 浏览器实例管理
├── stealth.py         # 反检测配置
└── platforms/
    ├── __init__.py
    ├── base.py        # PlatformAdapter 基类
    ├── xiaohongshu.py # 小红书登录/发布
    ├── douyin.py      # 抖音登录/发布
    └── wechat_mp.py   # 公众号登录/发布
```

#### 3.1.1 平台适配器基类

**文件**: `apps/sidecar/src/sidecar/automation/browser/platforms/base.py`

```python
from abc import ABC, abstractmethod
from playwright.async_api import Page, BrowserContext

class PlatformAdapter(ABC):
    """平台适配器基类"""
    
    platform_name: str
    login_url: str
    
    @abstractmethod
    async def login(self, page: Page) -> dict:
        """执行登录流程，返回凭证"""
        pass
    
    @abstractmethod
    async def check_session(self, context: BrowserContext) -> bool:
        """检查会话是否有效"""
        pass
    
    @abstractmethod
    async def get_user_info(self, page: Page) -> dict:
        """获取用户信息"""
        pass
    
    @abstractmethod
    async def publish(self, page: Page, content: dict) -> dict:
        """发布内容"""
        pass
```

#### 3.1.2 小红书适配器

**文件**: `apps/sidecar/src/sidecar/automation/browser/platforms/xiaohongshu.py`

```python
class XiaohongshuAdapter(PlatformAdapter):
    platform_name = "xiaohongshu"
    login_url = "https://creator.xiaohongshu.com/"
    
    async def login(self, page: Page) -> dict:
        """小红书扫码登录"""
        await page.goto(self.login_url)
        
        # 等待用户扫码
        # 检测登录成功
        # 保存 Cookies
        
        cookies = await page.context.cookies()
        return {"cookies": cookies}
    
    async def check_session(self, context: BrowserContext) -> bool:
        """检查会话有效性"""
        page = await context.new_page()
        await page.goto(self.login_url)
        
        # 检查是否需要重新登录
        is_valid = await page.query_selector(".user-avatar") is not None
        await page.close()
        return is_valid
```

### 3.2 凭证存储

**文件**: `apps/sidecar/src/sidecar/storage/credential.py`

```python
from agent_core.crypto.credential_crypto import encrypt_credential, decrypt_credential

class CredentialStore:
    """本地凭证存储 (加密)"""
    
    def __init__(self, db_path: str, master_key: bytes):
        self.db_path = db_path
        self.master_key = master_key
    
    async def save(self, account_id: str, platform: str, credential: dict):
        """加密保存凭证"""
        encrypted = encrypt_credential(credential, self.master_key)
        # 存入 SQLite
        
    async def load(self, account_id: str, platform: str) -> dict | None:
        """解密加载凭证"""
        encrypted = ...  # 从 SQLite 读取
        return decrypt_credential(encrypted, self.master_key)
```

### 3.3 前端 UI

#### 3.3.1 账号管理页面

**文件**: `apps/desktop/src/routes/accounts.tsx` (已存在)

增强功能:
- 添加账号按钮 → 打开平台选择弹窗
- 平台卡片显示账号状态 (有效/失效)
- 失效账号显示"重新登录"按钮

#### 3.3.2 登录弹窗

**文件**: `apps/desktop/src/components/accounts/LoginDialog.tsx` (新增)

- 显示平台二维码
- 等待扫码完成
- 登录成功后关闭弹窗

### 3.4 Tauri Commands

**文件**: `apps/desktop/src-tauri/src/commands/account.rs`

```rust
#[tauri::command]
async fn start_platform_login(platform: String) -> Result<LoginSession, String>;

#[tauri::command]
async fn check_login_status(session_id: String) -> Result<LoginResult, String>;

#[tauri::command]
async fn check_account_session(account_id: String) -> Result<bool, String>;
```

### 3.5 Sidecar RPC

**文件**: `apps/sidecar/src/sidecar/handlers/account.py`

```python
@server.register("account.start_login")
async def start_login(platform: str) -> dict:
    """启动平台登录"""
    adapter = get_adapter(platform)
    page = await browser_manager.new_page()
    
    # 跳转到登录页
    await page.goto(adapter.login_url)
    
    return {
        "session_id": str(uuid4()),
        "login_url": adapter.login_url,
    }

@server.register("account.wait_login")
async def wait_login(session_id: str, timeout: int = 120) -> dict:
    """等待登录完成"""
    # 轮询检查登录状态
    # 登录成功后保存凭证
    pass

@server.register("account.check_session")
async def check_session(account_id: str, platform: str) -> bool:
    """检查账号会话状态"""
    credential = await credential_store.load(account_id, platform)
    if not credential:
        return False
    
    adapter = get_adapter(platform)
    context = await browser_manager.new_context(credential)
    return await adapter.check_session(context)
```

---

## 四、验证计划

### 4.1 手动测试

1. **添加小红书账号**:
   - 点击"添加账号" → 选择"小红书"
   - 弹出二维码扫码窗口
   - 手机扫码登录
   - 验证账号出现在列表，状态为"有效"

2. **状态监控**:
   - 账号过期后，状态变为"失效"
   - 点击"重新登录"可恢复

3. **账号删除**:
   - 点击"删除账号"
   - 确认后账号从列表移除

---

## 五、交付物清单

- [ ] `services/cloud-backend/backend/app/models/platform_account.py`
- [ ] `services/cloud-backend/backend/app/api/v1/accounts.py`
- [ ] `apps/sidecar/src/sidecar/automation/browser/manager.py`
- [ ] `apps/sidecar/src/sidecar/automation/browser/platforms/xiaohongshu.py`
- [ ] `apps/sidecar/src/sidecar/automation/browser/platforms/douyin.py`
- [ ] `apps/sidecar/src/sidecar/storage/credential.py`
- [ ] `apps/desktop/src/components/accounts/LoginDialog.tsx`
- [ ] `apps/desktop/src-tauri/src/commands/account.rs`
