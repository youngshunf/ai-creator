# 创流 (CreatorFlow) - 数据库设计与同步策略

> 版本: v1.0 | 更新: 2025-12-30 | 状态: 待确认

---

## 一、设计原则

### 1.1 核心原则

```yaml
云端优先 (Cloud-First):
  - 云端 PostgreSQL 为权威数据源 (Source of Truth)
  - 桌面端 SQLite 为本地缓存和离线工作空间
  - 数据最终一致性，非强一致性

离线优先 (Offline-First):
  - 桌面端支持完全离线创作
  - 联网后自动后台同步
  - 用户无感知的数据同步

冲突最小化:
  - 合理的数据分区（按 user_id/project_id）
  - Last-Write-Wins (LWW) + 版本向量
  - 关键冲突需用户确认
```

### 1.2 同步策略概览

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据同步策略架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                        云端 (PostgreSQL)                              │   │
│  │  - 权威数据源                                                          │   │
│  │  - 完整数据集                                                          │   │
│  │  - 多用户共享                                                          │   │
│  └────────────────────────────┬─────────────────────────────────────────┘   │
│                               │                                             │
│                               │ HTTPS + SSE                                 │
│                               │                                             │
│  ┌────────────────────────────▼─────────────────────────────────────────┐   │
│  │                      同步服务 (Sync Service)                          │   │
│  │  - 变更检测 (Change Detection)                                        │   │
│  │  - 冲突解决 (Conflict Resolution)                                     │   │
│  │  - 增量推送 (Incremental Push)                                        │   │
│  └────────────────────────────┬─────────────────────────────────────────┘   │
│                               │                                             │
│                               │ JSON Payloads                               │
│                               │                                             │
│  ┌────────────────────────────▼─────────────────────────────────────────┐   │
│  │                       桌面端 (SQLite)                                 │   │
│  │  - 本地缓存                                                            │   │
│  │  - 离线工作空间                                                        │   │
│  │  - 当前用户数据子集                                                    │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、数据库 Schema 设计

### 2.1 云端 PostgreSQL Schema

基于 `docs/08-数据模型.md`，完整 schema 包含以下表：

| 表名                    | 同步到桌面端 | 同步方向 | 说明                       |
| ----------------------- | ------------ | -------- | -------------------------- |
| `users`                 | ✅ 部分      | 下行     | 仅同步当前用户信息         |
| `projects`              | ✅ 全部      | 双向     | 用户的所有项目             |
| `platform_accounts`     | ✅ 全部      | 双向     | 用户的平台账号             |
| `contents`              | ✅ 全部      | 双向     | 用户的创作内容             |
| `content_versions`      | ✅ 全部      | 双向     | 内容版本历史               |
| `materials`             | ❌ 元数据    | 双向     | 素材元数据同步，文件不同步 |
| `publications`          | ✅ 全部      | 双向     | 发布任务                   |
| `publication_analytics` | ✅ 全部      | 下行     | 发布数据分析（只读）       |
| `encrypted_credentials` | ❌ 无        | -        | 仅云端存储（可选托管）     |
| `task_records`          | ❌ 无        | -        | 服务器任务，桌面端不需要   |
| `scheduled_tasks`       | ✅ 全部      | 双向     | 用户定时任务               |

### 2.2 桌面端 SQLite Schema

**基础模型（与云端一致）**:

```sql
-- 用户表（仅当前用户）
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    email TEXT NOT NULL,
    username TEXT,
    nickname TEXT,
    avatar_url TEXT,
    subscription_tier TEXT NOT NULL DEFAULT 'free',
    settings TEXT, -- JSON

    -- 同步元数据
    synced_at INTEGER, -- Unix timestamp
    server_version INTEGER DEFAULT 0,

    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL
);

-- 项目表
CREATE TABLE projects (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    name TEXT NOT NULL,
    description TEXT,

    -- 行业领域
    industry TEXT,
    sub_industries TEXT, -- JSON array

    -- 品牌信息
    brand_name TEXT,
    brand_tone TEXT,
    brand_keywords TEXT, -- JSON array

    -- 内容定位
    topics TEXT, -- JSON array
    keywords TEXT, -- JSON array
    account_tags TEXT, -- JSON array

    -- 偏好设置
    preferred_platforms TEXT, -- JSON array
    content_style TEXT,
    settings TEXT, -- JSON

    is_default INTEGER DEFAULT 0,
    is_deleted INTEGER DEFAULT 0,
    deleted_at INTEGER,

    -- 同步元数据
    synced_at INTEGER,
    server_version INTEGER DEFAULT 0,
    local_version INTEGER DEFAULT 0,
    sync_status TEXT DEFAULT 'synced', -- synced, pending, conflict

    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,

    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 平台账号表
CREATE TABLE platform_accounts (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    project_id TEXT NOT NULL,

    platform TEXT NOT NULL,
    account_id TEXT NOT NULL,
    account_name TEXT,
    avatar_url TEXT,

    is_active INTEGER DEFAULT 1,
    session_valid INTEGER DEFAULT 1,
    last_session_check INTEGER,

    followers_count INTEGER DEFAULT 0,
    following_count INTEGER DEFAULT 0,
    posts_count INTEGER DEFAULT 0,
    likes_count INTEGER DEFAULT 0, -- 获赞数

    bio TEXT, -- 个人简介
    metadata TEXT, -- JSON

    is_deleted INTEGER DEFAULT 0,
    deleted_at INTEGER,

    -- 同步元数据
    synced_at INTEGER,
    server_version INTEGER DEFAULT 0,
    local_version INTEGER DEFAULT 0,
    sync_status TEXT DEFAULT 'synced',

    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,

    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (project_id) REFERENCES projects(id)
);

-- 内容表
CREATE TABLE contents (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    project_id TEXT NOT NULL,

    title TEXT,
    content_type TEXT NOT NULL,
    status TEXT DEFAULT 'draft',

    text_content TEXT,
    summary TEXT,

    media_urls TEXT, -- JSON array
    cover_url TEXT,

    tags TEXT, -- JSON array
    keywords TEXT, -- JSON array
    word_count INTEGER DEFAULT 0,
    read_time_minutes INTEGER DEFAULT 0,

    ai_generated INTEGER DEFAULT 0,
    generation_params TEXT, -- JSON

    version INTEGER DEFAULT 1,
    parent_id TEXT,

    is_deleted INTEGER DEFAULT 0,
    deleted_at INTEGER,

    -- 同步元数据
    synced_at INTEGER,
    server_version INTEGER DEFAULT 0,
    local_version INTEGER DEFAULT 0,
    sync_status TEXT DEFAULT 'synced',

    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,

    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (parent_id) REFERENCES contents(id)
);

-- 发布任务表
CREATE TABLE publications (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    content_id TEXT NOT NULL,
    account_id TEXT NOT NULL,

    platform TEXT NOT NULL,
    status TEXT DEFAULT 'pending',

    adapted_content TEXT, -- JSON
    scheduled_at INTEGER,
    published_at INTEGER,

    platform_post_id TEXT,
    platform_post_url TEXT,

    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    last_retry_at INTEGER,

    -- 同步元数据
    synced_at INTEGER,
    server_version INTEGER DEFAULT 0,
    local_version INTEGER DEFAULT 0,
    sync_status TEXT DEFAULT 'synced',

    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,

    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (content_id) REFERENCES contents(id),
    FOREIGN KEY (account_id) REFERENCES platform_accounts(id)
);

-- 团队表
CREATE TABLE teams (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    logo_url TEXT,
    owner_id TEXT NOT NULL,

    settings TEXT, -- JSON
    max_members INTEGER DEFAULT 10,
    max_accounts INTEGER DEFAULT 20,

    is_deleted INTEGER DEFAULT 0,
    deleted_at INTEGER,

    -- 同步元数据
    synced_at INTEGER,
    server_version INTEGER DEFAULT 0,
    local_version INTEGER DEFAULT 0,
    sync_status TEXT DEFAULT 'synced',

    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,

    FOREIGN KEY (owner_id) REFERENCES users(id)
);

-- 团队成员表
CREATE TABLE team_members (
    id TEXT PRIMARY KEY,
    team_id TEXT NOT NULL,
    user_id TEXT NOT NULL,

    role TEXT NOT NULL DEFAULT 'editor', -- owner, admin, editor, viewer
    is_active INTEGER DEFAULT 1,
    invited_by TEXT,
    joined_at INTEGER,

    -- 同步元数据
    synced_at INTEGER,
    server_version INTEGER DEFAULT 0,
    local_version INTEGER DEFAULT 0,
    sync_status TEXT DEFAULT 'synced',

    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,

    FOREIGN KEY (team_id) REFERENCES teams(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (invited_by) REFERENCES users(id)
);

-- 视频生成任务表
CREATE TABLE video_generation_tasks (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    project_id TEXT NOT NULL,

    workflow_id TEXT NOT NULL,
    prompt_id TEXT, -- ComfyUI Prompt ID
    status TEXT DEFAULT 'pending', -- pending, processing, completed, failed

    input_params TEXT, -- JSON
    output_url TEXT,
    progress INTEGER DEFAULT 0,
    error_message TEXT,

    -- 同步元数据
    synced_at INTEGER,
    server_version INTEGER DEFAULT 0,
    local_version INTEGER DEFAULT 0,
    sync_status TEXT DEFAULT 'synced',

    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,

    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

**同步元数据表**:

```sql
-- 同步状态跟踪表
CREATE TABLE sync_metadata (
    table_name TEXT PRIMARY KEY,
    last_sync_at INTEGER, -- 上次同步时间
    last_server_version INTEGER DEFAULT 0, -- 服务器最新版本号
    sync_cursor TEXT, -- 同步游标（用于分页）
    sync_direction TEXT DEFAULT 'bidirectional' -- bidirectional, downstream, upstream
);

-- 冲突记录表
CREATE TABLE sync_conflicts (
    id TEXT PRIMARY KEY,
    table_name TEXT NOT NULL,
    record_id TEXT NOT NULL,

    -- 冲突数据
    local_data TEXT NOT NULL, -- JSON
    server_data TEXT NOT NULL, -- JSON

    -- 冲突解决
    status TEXT DEFAULT 'pending', -- pending, resolved_local, resolved_server, resolved_manual
    resolved_at INTEGER,
    resolution TEXT, -- JSON (记录如何解决的)

    created_at INTEGER NOT NULL
);

-- 待同步变更队列
CREATE TABLE sync_queue (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    table_name TEXT NOT NULL,
    record_id TEXT NOT NULL,
    operation TEXT NOT NULL, -- insert, update, delete

    -- 变更数据
    data TEXT NOT NULL, -- JSON
    local_version INTEGER NOT NULL,

    status TEXT DEFAULT 'pending', -- pending, syncing, synced, failed
    retry_count INTEGER DEFAULT 0,
    error_message TEXT,

    created_at INTEGER NOT NULL
);

-- 索引
CREATE INDEX idx_sync_queue_status ON sync_queue(status);
CREATE INDEX idx_sync_queue_table ON sync_queue(table_name, status);
CREATE INDEX idx_sync_conflicts_status ON sync_conflicts(status);
```

---

## 三、数据同步策略

### 3.1 同步触发机制

```yaml
触发场景:
  应用启动:
    - 检查网络连接
    - 如果在线，立即执行完整同步

  网络状态变化:
    - 从离线转为在线时自动同步

  定时同步:
    - 在线时每 5 分钟执行增量同步

  用户主动:
    - 设置页面提供"立即同步"按钮
    - 发布任务完成后立即同步

  数据变更:
    - 本地数据修改后标记为 pending
    - 下次同步时上传
```

### 3.2 增量同步实现

**基于版本向量 (Vector Clock)**:

```python
# 同步算法伪代码
async def sync_table(table_name: str):
    """增量同步单表"""

    # 1. 获取本地同步元数据
    local_meta = await db.get_sync_metadata(table_name)
    last_server_version = local_meta.last_server_version

    # 2. 拉取服务器变更 (Pull)
    server_changes = await api.get_changes(
        table=table_name,
        since_version=last_server_version,
        user_id=current_user.id
    )

    # 3. 应用服务器变更到本地
    for change in server_changes:
        local_record = await db.get(table_name, change.id)

        if local_record is None:
            # 服务器新增，直接插入
            await db.insert(table_name, change.data)

        elif local_record.sync_status == 'synced':
            # 本地无变更，直接覆盖
            await db.update(table_name, change.id, change.data)

        else:
            # 冲突：本地和服务器都有变更
            await handle_conflict(table_name, change.id, local_record, change)

    # 4. 推送本地变更到服务器 (Push)
    local_changes = await db.get_pending_changes(table_name)

    for change in local_changes:
        try:
            result = await api.push_change(
                table=table_name,
                operation=change.operation,
                data=change.data
            )

            # 更新本地版本号
            await db.update_version(table_name, change.id, result.server_version)
            await db.mark_synced(table_name, change.id)

        except ConflictError as e:
            # 服务器检测到冲突
            await handle_conflict(table_name, change.id, change.data, e.server_data)

    # 5. 更新同步元数据
    await db.update_sync_metadata(
        table_name,
        last_sync_at=now(),
        last_server_version=server_changes.latest_version
    )
```

### 3.3 冲突解决策略

```yaml
冲突类型与解决:
  1. 简单字段冲突 (Last-Write-Wins):
    - 比较 updated_at 时间戳
    - 保留最新的修改
    - 适用表: users, projects, platform_accounts

  2. 内容冲突 (用户确认):
    - 创作内容 (contents) 冲突需要用户选择
    - 展示本地版本 vs 服务器版本
    - 允许用户合并或选择其一
    - 选择后自动创建新版本

  3. 删除冲突:
    - 本地删除 + 服务器修改 → 保留服务器修改
    - 本地修改 + 服务器删除 → 创建新记录

  4. 发布任务冲突:
    - status 字段：服务器优先（发布状态由服务器控制）
    - 其他字段：Last-Write-Wins

  5. 视频生成任务冲突:
    - status/progress/output_url 字段：服务器优先（由生成服务控制）
    - 其他字段：Last-Write-Wins
```

**冲突解决 UI**:

```typescript
// 前端冲突解决界面
interface ConflictResolution {
  conflicts: Conflict[]

  resolveConflict(conflictId: string, choice: 'local' | 'server' | 'merge') {
    if (choice === 'merge') {
      // 打开合并编辑器
      showMergeEditor(conflict.localData, conflict.serverData)
    } else {
      // 直接选择一方
      api.resolveConflict(conflictId, {
        resolution: choice,
        winner_data: choice === 'local' ? conflict.localData : conflict.serverData
      })
    }
  }
}
```

### 3.4 数据分区策略

```yaml
按用户隔离:
  - 桌面端仅同步当前登录用户的数据
  - WHERE user_id = current_user.id

按项目隔离:
  - 可选：仅同步当前激活项目
  - 节省本地存储空间
  - 项目切换时按需拉取

时间窗口限制:
  - 默认同步最近 30 天数据
  - 旧数据可按需拉取
  - publication_analytics 只同步最近 7 天
```

---

## 四、API 设计

### 4.1 同步 API 端点

```yaml
GET /api/v1/sync/changes:
  描述: 获取服务器变更
  参数:
    - table: 表名
    - since_version: 起始版本号
    - limit: 每页条数 (默认 100)
  返回:
    - changes: 变更记录列表
    - latest_version: 服务器最新版本号
    - has_more: 是否有更多数据

POST /api/v1/sync/push:
  描述: 推送本地变更
  请求体:
    - table: 表名
    - operation: insert | update | delete
    - data: 变更数据
    - local_version: 本地版本号
  返回:
    - server_version: 服务器分配的版本号
    - conflict: 是否冲突 (bool)
    - server_data: 服务器数据（如果冲突）

POST /api/v1/sync/resolve-conflict:
  描述: 提交冲突解决方案
  请求体:
    - conflict_id: 冲突 ID
    - resolution: local | server | merged
    - merged_data: 合并后的数据（如果 resolution=merged）
  返回:
    - success: bool
    - new_version: 新版本号

GET /api/v1/sync/status:
  描述: 获取同步状态概览
  返回:
    - last_sync_at: 上次同步时间
    - pending_changes: 待同步变更数
    - conflicts: 冲突数
    - sync_health: healthy | degraded | offline
```

### 4.2 同步数据格式

```json
{
  "changes": [
    {
      "id": "uuid",
      "table": "contents",
      "operation": "update",
      "version": 42,
      "data": {
        "id": "content-id",
        "title": "Updated Title",
        "text_content": "...",
        "updated_at": 1704000000
      },
      "timestamp": 1704000000
    }
  ],
  "latest_version": 45,
  "has_more": false
}
```

---

## 五、离线支持

### 5.1 离线创作流程

```text
1. 用户离线打开应用
   └─> 检测到无网络连接
   └─> 显示"离线模式"指示器

2. 用户创作内容
   └─> 正常使用所有本地功能
   └─> 数据写入本地 SQLite
   └─> sync_status 标记为 'pending'
   └─> 加入 sync_queue 表

3. 用户尝试发布（离线）
   └─> 提示："发布任务已保存，将在联网后自动执行"
   └─> publication.status = 'pending'

4. 网络恢复
   └─> 自动触发后台同步
   └─> 上传所有 pending 变更
   └─> 执行待发布任务
```

### 5.2 离线限制

```yaml
离线可用功能: ✅ AI 创作 (如果本地有 LLM，否则需联网)
  ✅ 内容编辑
  ✅ 草稿保存
  ✅ 素材管理 (已下载的素材)
  ✅ 历史内容查看
  ✅ 账号管理（查看）

离线不可用: ❌ 发布到平台（立即发布）
  ❌ 数据分析刷新
  ❌ 热点追踪
  ❌ 云端素材下载
  ❌ 模型切换（如需云端配置）
```

---

## 六、性能优化

### 6.1 同步性能优化

```yaml
批量操作:
  - 单次同步最多拉取 100 条变更
  - 本地变更批量推送（5 条/批）

压缩传输:
  - 使用 gzip 压缩 JSON payload
  - 减少 70% 流量

增量字段:
  - 仅同步变更的字段，非全记录
  - 使用 JSON Patch (RFC 6902)

智能调度:
  - 网络状态良好时提高同步频率
  - 弱网环境下降低频率，避免超时
  - 使用指数退避重试策略
```

### 6.2 本地存储优化

```yaml
SQLite 优化:
  - 启用 WAL 模式 (Write-Ahead Logging)
  - 合理使用索引（避免过多）
  - 定期 VACUUM 清理碎片
  - 软删除记录定期归档

缓存策略:
  - 使用 LRU 缓存热数据
  - 媒体文件懒加载
  - 分析数据按需拉取
```

---

## 七、监控与日志

### 7.1 同步监控指标

```yaml
关键指标:
  - 同步成功率 (%)
  - 平均同步延迟 (秒)
  - 冲突率 (%)
  - 离线时长 (小时)
  - 待同步队列长度

告警规则:
  - 同步成功率 < 95% → 警告
  - 待同步队列 > 100 → 警告
  - 单次同步耗时 > 30s → 警告
```

### 7.2 同步日志

```sql
-- 同步日志表 (可选)
CREATE TABLE sync_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    sync_id TEXT NOT NULL, -- 本次同步的唯一 ID
    table_name TEXT NOT NULL,
    direction TEXT NOT NULL, -- pull | push

    records_count INTEGER DEFAULT 0,
    success_count INTEGER DEFAULT 0,
    failed_count INTEGER DEFAULT 0,
    conflict_count INTEGER DEFAULT 0,

    duration_ms INTEGER,
    error_message TEXT,

    created_at INTEGER NOT NULL
);
```

---

## 八、安全考虑

### 8.1 数据传输安全

```yaml
传输加密:
  - HTTPS/TLS 1.3
  - Certificate Pinning（可选）

身份验证:
  - JWT Token (短期，15 分钟)
  - Refresh Token (长期，30 天)
  - 设备指纹验证

数据校验:
  - 请求签名 (HMAC-SHA256)
  - 防重放攻击 (Nonce + Timestamp)
```

### 8.2 本地数据安全

```yaml
SQLite 加密:
  - 使用 SQLCipher 加密数据库
  - 密钥存储在系统 Keychain
  - AES-256-CBC 加密

敏感数据处理:
  - 平台凭证不存储在 SQLite
  - 仅存储加密后的 token
  - 用户可选择是否云端托管凭证
```

---

## 九、故障恢复

### 9.1 同步失败处理

```yaml
重试策略:
  初次失败: 立即重试
  第二次: 等待 5 秒
  第三次: 等待 30 秒
  第四次: 等待 5 分钟
  第五次: 等待 30 分钟
  最大重试: 10 次

失败类型处理:
  网络超时: 自动重试
  服务器 5xx: 自动重试
  客户端 4xx: 记录错误，不重试
  冲突: 进入冲突解决流程
```

### 9.2 数据恢复

```yaml
本地备份:
  - 每日自动备份 SQLite 数据库
  - 保留最近 7 天备份
  - 用户可手动导出备份

云端恢复:
  - 用户可重置本地数据库
  - 从云端完整拉取数据
  - 需用户确认（警告会丢失未同步数据）
```

---

## 十、实施计划

### 10.1 开发阶段

| 阶段        | 任务              | 工期     |
| ----------- | ----------------- | -------- |
| **Phase 1** | 云端同步 API 开发 | Week 1-2 |
| **Phase 2** | 桌面端同步客户端  | Week 3-4 |
| **Phase 3** | 冲突解决 UI       | Week 5   |
| **Phase 4** | 性能优化 + 测试   | Week 6   |

### 10.2 验收标准

```yaml
功能验收:
  - [ ] 单设备数据完整同步
  - [ ] 多设备数据一致性
  - [ ] 离线创作 + 联网同步
  - [ ] 冲突检测与解决
  - [ ] 增量同步性能达标

性能验收:
  - [ ] 同步成功率 > 99%
  - [ ] 100 条记录同步 < 5 秒
  - [ ] 冲突率 < 1%
  - [ ] 离线模式功能正常
```

---

## 相关文档

- [数据模型](./08-数据模型.md)
- [需求规格](./13-需求规格.md) - 2.10 端云同步模块
- [系统架构](./01-系统架构.md)

---

> 文档版本: v1.0
> 更新日期: 2025-12-30
> 作者: @Ysf
