# 创流 (CreatorFlow) 桌面端开发计划 v2.0

> 版本: v2.0 | 更新: 2025-12-30 | 状态: 待确认

---

## 一、项目概述

### 1.1 项目目标

基于 `docs/01-系统架构.md` 和 `docs/02-桌面端设计.md` 的设计，开发创流桌面端应用，实现自媒体创作者的 AI 超级大脑。

### 1.2 技术栈

```yaml
桌面端:
  框架: Tauri 2.0 + Python Sidecar
  前端: Vite 6 + React 19 + TypeScript 5 + shadcn/ui + Tailwind CSS 4
  状态管理: Zustand + TanStack Query v5
  路由: TanStack Router
  编辑器: TipTap

后端:
  Rust Core: Tauri 后端、IPC、系统集成
  Python Sidecar: Agent 执行、浏览器自动化、LLM 网关
  本地存储: SQLite
  浏览器自动化: Playwright
```

### 1.3 已完成的 Agent Core 功能 (Phases 1-4)

> **重要**: 以下 Agent Core 功能已在 2025-12-30 完成实现，桌面端需集成这些能力。

| 模块 | 状态 | 说明 |
|------|------|------|
| `packages/agent-core/skill/` | ✅ 完成 | SkillManager, SkillLoader, Markdown Skill 支持 |
| `packages/agent-core/graph/` | ✅ 完成 | GraphCompiler (循环支持)、GraphValidator、Subgraph |
| `packages/agent-core/tools/browser/` | ✅ 完成 | BrowserManager, Navigate/Screenshot/Click/Type 工具 |
| `packages/agent-core/tools/builtin/` | ✅ 完成 | LLMGenerateTool (工具调用)、ToolExecutionTool |
| `packages/agent-core/discovery/` | ✅ 完成 | DiscoveryService, 发现工具 (list_agents, get_tool 等) |
| `packages/agent-core/ui/` | ✅ 完成 | UIComponent/UIMessage 协议 (A2UI) |
| `agent-definitions/` | ✅ 完成 | 7 个 Graph 定义 + 4 个 Skills |
| `apps/sidecar/` | ✅ 完成 | LocalExecutor + JSON-RPC 服务 |
| `apps/desktop/src/components/a2ui/` | ✅ 完成 | NativeUIRenderer, componentMap (14 种组件) |

---

## 二、分阶段开发计划

### Phase 1: 前端-Sidecar 集成 (Week 1-2)

**目标**: 完成前端与 Sidecar 的通信，实现 Agent 执行的端到端流程

| 任务 | 优先级 | 工时 | 交付物 | 依赖 |
|------|--------|------|--------|------|
| JSON-RPC 客户端封装 (`lib/sidecar-client.ts`) | P0 | 1d | Sidecar 通信层 | - |
| `useSidecar` Hook 实现 | P0 | 1d | 前端 Hook | sidecar-client |
| `useAgent` Hook (执行 Graph) | P0 | 1d | Agent 调用封装 | useSidecar |
| Sidecar 进程管理 (Rust 层) | P0 | 2d | 进程生命周期 | - |
| 健康检查 + 自动重连 | P0 | 1d | 稳定性保障 | - |
| 开发环境配置 (热重载) | P1 | 1d | 开发体验 | - |

**验收标准**:
- [ ] 前端可通过 `useAgent` 执行任意 Graph
- [ ] Sidecar 进程异常时自动重启
- [ ] JSON-RPC 通信延迟 < 50ms

---

### Phase 2: Agent 输出实时展示 (Week 3-4)

**目标**: 实现 Agent 执行过程的实时可视化展示

| 任务 | 优先级 | 工时 | 交付物 | 对应需求 |
|------|--------|------|--------|---------|
| SSE 事件流接收组件 | P0 | 2d | 事件流消费 | F-AGENT-050 |
| 流式文本展示 (打字机效果) | P0 | 1d | 文本流渲染 | F-AGENT-050 |
| 节点执行状态组件 (`ExecutionTimeline`) | P0 | 2d | 节点状态展示 | F-AGENT-051 |
| 执行进度条组件 | P0 | 1d | 进度可视化 | F-AGENT-052 |
| 工具调用折叠面板 | P1 | 1d | 工具详情展示 | F-AGENT-053 |
| 执行日志抽屉 | P0 | 1d | 日志查看 | F-AGENT-055 |
| 错误提示 Toast | P0 | 0.5d | 错误反馈 | F-AGENT-056 |

**组件设计**:

```tsx
// ExecutionPanel 组件结构
<ExecutionPanel>
  <ExecutionHeader title="热点内容创作" status="running" />
  <ExecutionTimeline nodes={nodes} currentNode="generate" />
  <StreamingOutput content={streamContent} />
  <ProgressBar value={40} />
  <ToolCallsAccordion calls={toolCalls} />
  <ExecutionActions onPause={} onCancel={} />
</ExecutionPanel>
```

**验收标准**:
- [ ] LLM 输出实时逐字显示，无明显延迟
- [ ] 节点执行状态正确高亮显示
- [ ] 进度条准确反映执行进度
- [ ] 错误信息 2 秒内展示

---

### Phase 3: A2UI 集成 (Week 5-6)

**目标**: 将已实现的 NativeUIRenderer 集成到聊天/执行界面

| 任务 | 优先级 | 工时 | 交付物 | 对应需求 |
|------|--------|------|--------|---------|
| UI_RENDER 事件处理 | P0 | 1d | 事件解析 | F-AGENT-040 |
| 聊天消息类型扩展 (支持 UI 类型) | P0 | 1d | 消息结构 | - |
| A2UI 消息渲染集成 | P0 | 2d | UI 渲染集成 | F-AGENT-040 |
| 表单数据收集 Hook | P0 | 1d | 数据绑定 | F-AGENT-044 |
| 用户交互回传 (onEvent → Sidecar) | P0 | 2d | 交互闭环 | F-AGENT-044 |
| A2UI 组件样式适配 (Design System) | P0 | 1d | 样式一致性 | F-AGENT-045 |

**集成示例**:

```tsx
// ChatMessage 组件增强
function ChatMessage({ message }) {
  if (message.type === 'ui_render') {
    return (
      <NativeUIRenderer 
        ui={message.ui}
        onEvent={(actionId, data) => {
          sidecar.send('ui_response', { actionId, formData: data })
        }}
      />
    )
  }
  return <MarkdownMessage content={message.content} />
}
```

**验收标准**:
- [ ] Agent 可生成表单，用户可填写并提交
- [ ] 提交后 Agent 收到数据并继续执行
- [ ] UI 组件样式与应用一致

---

### Phase 4: 自定义工作流 UI (Week 7-9)

**目标**: 实现工作流创建、管理、执行的完整界面

| 任务 | 优先级 | 工时 | 交付物 | 对应需求 |
|------|--------|------|--------|---------|
| 工作流创建聊天窗口 | P0 | 2d | 自然语言创建入口 | F-AGENT-030 |
| 工作流 YAML 预览/编辑器 | P0 | 2d | YAML 编辑 | F-AGENT-031 |
| 工作流图形预览 (Reactflow) | P1 | 3d | 可视化预览 | F-AGENT-031 |
| 工作流列表页 | P0 | 1d | 工作流管理 | F-AGENT-032 |
| 工作流模板库 | P0 | 2d | 模板选择 | F-AGENT-032 |
| 工作流参数配置表单 | P0 | 2d | 参数输入 | F-AGENT-033 |
| 工作流执行页面 | P0 | 2d | 执行界面 | - |

**页面结构**:

```
/workflows
  ├── /                  # 工作流列表
  ├── /new              # 创建工作流 (聊天式)
  ├── /templates        # 模板库
  ├── /:id              # 工作流详情
  ├── /:id/edit         # 编辑工作流
  └── /:id/run          # 执行工作流
```

**验收标准**:
- [ ] 用户可用自然语言创建工作流
- [ ] 生成的 YAML 正确且可执行
- [ ] 工作流可保存、复制、删除
- [ ] 模板库包含 5+ 常用模板

---

### Phase 5: AI 创作模块 (Week 10-12)

**目标**: 实现核心的 AI 创作功能

| 任务 | 优先级 | 工时 | 交付物 |
|------|--------|------|--------|
| TipTap 富文本编辑器集成 | P0 | 3d | 创作编辑器 |
| AI 写作功能 (调用 content-creation) | P0 | 2d | AI 生成能力 |
| 写作风格模板选择器 | P0 | 2d | 风格选择 UI |
| 内容续写/改写/扩写 | P0 | 2d | 编辑增强 |
| 草稿自动保存 + 历史版本 | P0 | 2d | 数据安全 |
| AI 选题推荐面板 | P0 | 2d | 选题推荐 |

**验收标准**:
- [ ] AI 写作功能完整，支持 10+ 种风格
- [ ] 流式输出实时显示在编辑器中
- [ ] 草稿 5 秒自动保存

---

### Phase 6: 多平台发布 (Week 13-16)

**目标**: 实现多平台内容发布功能

| 任务 | 优先级 | 工时 | 交付物 |
|------|--------|------|--------|
| 发布中心 UI | P0 | 2d | 发布界面 |
| 平台账号绑定 (Cookie/OAuth) | P0 | 3d | 账号管理 |
| 小红书发布 (browser_navigate等) | P0 | 3d | 小红书发布 |
| 微博发布 | P0 | 2d | 微博发布 |
| 公众号发布 (API) | P0 | 2d | 公众号发布 |
| 内容平台适配规则 | P0 | 2d | 自动适配 |
| 发布预览 (各平台效果) | P0 | 2d | 预览功能 |
| 定时发布 | P0 | 2d | 定时任务 |
| 发布状态追踪 | P0 | 1d | 状态管理 |

**验收标准**:
- [ ] 3 个 P0 平台发布成功率 > 95%
- [ ] 定时发布误差 < 1 分钟

---

## 三、关键文件路径

### 3.1 待创建/完善的核心文件

```
apps/desktop/src/
├── components/
│   ├── a2ui/                         # ✅ 已完成
│   │   ├── NativeUIRenderer.tsx
│   │   ├── componentMap.tsx
│   │   └── index.ts
│   ├── agent/                        # 待创建
│   │   ├── ExecutionPanel.tsx        # 执行面板
│   │   ├── ExecutionTimeline.tsx     # 节点时间线
│   │   ├── StreamingOutput.tsx       # 流式输出
│   │   └── ToolCallsAccordion.tsx    # 工具调用详情
│   ├── workflow/                     # 待创建
│   │   ├── WorkflowEditor.tsx        # YAML 编辑器
│   │   ├── WorkflowGraph.tsx         # 图形预览
│   │   ├── WorkflowTemplates.tsx     # 模板列表
│   │   └── WorkflowRunner.tsx        # 执行器
│   └── creation/                     # 待创建
│       ├── AIWriter.tsx              # AI 写作
│       └── StyleSelector.tsx         # 风格选择
├── hooks/
│   ├── useSidecar.ts                 # 待创建
│   ├── useAgent.ts                   # 待创建
│   └── useStreamingOutput.ts         # 待创建
├── lib/
│   ├── sidecar-client.ts             # 待创建
│   └── event-stream.ts               # 待创建
└── routes/
    ├── workflows/                    # 待创建
    │   ├── index.tsx
    │   ├── new.tsx
    │   └── $id.tsx
    └── creation/                     # 待增强
        └── index.tsx
```

---

## 四、验收标准汇总

| Phase | 关键验收点 |
|-------|-----------|
| **Phase 1** | 前端可执行 Graph，Sidecar 通信正常 |
| **Phase 2** | 流式输出实时显示，节点状态准确 |
| **Phase 3** | A2UI 表单可交互，数据可回传 |
| **Phase 4** | 自然语言创建工作流，可执行 |
| **Phase 5** | AI 写作完整，10+ 风格支持 |
| **Phase 6** | 3 平台发布成功率 > 95% |

---

## 五、风险和应对策略

| 风险 | 概率 | 影响 | 应对策略 |
|------|------|------|---------|
| Sidecar 进程不稳定 | 中 | 高 | 健康检查 + 自动重启 + 错误隔离 |
| 流式输出卡顿 | 中 | 中 | 防抖 + 虚拟滚动 + 分块渲染 |
| A2UI 组件样式不一致 | 低 | 中 | 统一使用 Design System 组件 |
| 工作流 YAML 生成错误 | 中 | 高 | 前端验证 + 错误提示 + 修复建议 |

---

## 六、相关文档

- [系统架构](./01-系统架构.md)
- [桌面端设计](./02-桌面端设计.md)
- [需求规格](./13-需求规格.md) - 2.8.5-2.8.7 节
- [Agent-Runtime](./05-Agent-Runtime.md)
- [A2UI 集成评估](./06-A2UI集成评估.md)

---

> 文档版本: v2.0
> 更新日期: 2025-12-30
> 作者: @Ysf
