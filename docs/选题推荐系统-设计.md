/\*

# 选题推荐系统-设计

## 目标

构建一个完整的选题推荐系统，按“行业 + 关键词”聚合各社交媒体热点，生成可直接落库的选题卡片（不仅推荐选题，还推荐创作方向），并支持：

- 云端系统选题库：每天定时使用 `sys_industry` 生成并更新 `sys_topic`
- 用户私有选题库：按用户项目 `projects` 配置生成私有选题，落库到本地并可同步到云端
- LLM 调用统一走 LLM 网关（端云一致）

## 现有基础（代码现状）

- 系统行业库：`sys_industry`（行业与关键词 JSONB）
- 系统选题库：`sys_topic`（选题卡片字段已扩展为多列 JSONB）
- 云端已有 Celery task：`daily_topic_recommendation_task`（当前逻辑基于 BettaFish/Mock，需要替换为 agent-core 引擎）
- 桌面端已有 SyncEngine 框架：本地表含 `server_version/local_version/sync_status`，云端已有“项目作用域实体同步”的成熟范式（平台账号 `sync_upsert`）

## 两套选题库

### 1) 系统选题库：sys_topic

定位：平台级“系统推荐”，由运营维护的行业库驱动，每日生成。

数据源：`sys_industry`（系统行业关键词）。

落库约束：`sys_topic` 的所有字段必须写入（即使为空结构，也要写空数组/空对象），避免出现 NULL 造成前端展示/筛选异常。

### 2) 用户私有选题库：project_topics（新增）

定位：用户项目（`projects`）范围内的私有选题，按用户项目的行业/关键词/话题偏好生成，可离线缓存，并可同步到云端供多端使用。

数据源：`projects.industry/sub_industries/keywords/topics/preferred_platforms/...`。

同步：桌面端生成后写入本地 `project_topics` 表，标记 `sync_status='pending'`，由 SyncEngine Provider push 到云端；云端提供 `sync_upsert` 接口并维护 `server_version`。

## 核心链路与职责分层

### agent-core（可复用算法层）

职责：实现“热点获取/归一化 + LLM 结构化生成”的核心算法，输入为行业/关键词，输出为结构化 TopicCard（字段对齐 sys_topic 全量字段）。

组件：

- `HotTopicProvider`：从外部系统获取热点（优先 TrendRadar；不可用时降级 newsnow）
- `TopicAnalyzer`：调用 LLM 网关生成 TopicCard（严格 JSON 输出 + Pydantic 校验 + 默认值填充）
- `TopicRecommender`：编排 Provider 与 Analyzer，完成去重、聚合与输出

### cloud-backend（系统库落库 + 调度 + 私有库服务端）

职责：

- 系统库：每日定时跑 `sys_industry → sys_topic`，并保证幂等与全字段写入
- 私有库：提供 `project_topics` 模型、查询与 `sync_upsert` API，承接桌面端同步

### desktop（私有库本地缓存 + 同步）

职责：

- 新增本地 `project_topics` 表，用于存储用户私有选题（payload 存全字段 JSON）
- 提供命令：读取本地 projects 配置 → 调用 Sidecar（agent-core）生成 → 写入本地 `project_topics`（pending）
- SyncEngine：新增 ProjectTopicProvider，实现 pull/push

## 数据源：TrendRadar 与降级

TrendRadar 特性（来自项目说明）：

- 多平台热点聚合、RSS 订阅、关键词筛选
- 支持 AI 分析简报与 MCP 架构扩展
- 数据来源之一为 newsnow API

集成策略：

1. 优先对接 TrendRadar 的可程序化输出（实现阶段通过阅读其 `mcp_server` 或服务代码确定调用方式）
2. 若 TrendRadar 输出接口不可直接调用或仅支持 MCP 且成本过高，则降级为直接调用 newsnow 聚合 API，以保障“热点聚合”能力

## sys_topic 全字段映射与默认值

`sys_topic` 字段必须全部入库（系统库与用户库同口径）。推荐统一由 `TopicCard.ensure_defaults()` 保证默认值。

| 字段               | 来源                      | 默认值                        |
| ------------------ | ------------------------- | ----------------------------- |
| title              | LLM                       | 必填                          |
| industry_id        | 上下文                    | 必填（系统库）/可选（用户库） |
| potential_score    | LLM/归一化热度            | 0.0                           |
| heat_index         | Provider/LLM              | 0.0                           |
| reason             | LLM                       | 必填（至少短句）              |
| keywords           | LLM/行业关键词            | 空数组                        |
| platform_heat      | Provider/LLM              | 空对象                        |
| heat_sources       | Provider/LLM              | 空数组                        |
| trend              | Provider/LLM              | 空对象                        |
| industry_tags      | LLM/行业                  | 空数组                        |
| target_audience    | LLM                       | 空数组                        |
| creative_angles    | LLM                       | 空数组                        |
| content_outline    | LLM                       | 空数组                        |
| format_suggestions | LLM                       | 空数组                        |
| material_clues     | LLM                       | 空数组                        |
| risk_notes         | LLM                       | 空数组                        |
| source_info        | Provider 输入与分析元信息 | 空对象                        |
| status             | 系统默认                  | 0                             |

## 幂等与去重

系统库与用户库都需要避免“同日重复生成导致重复垃圾数据”。建议新增：

- `batch_date`：生成批次日期（DATE）
- `source_uid`：幂等键（行业/项目 + topic_key + batch_date 的 hash）

更新策略：

- 以 `(batch_date, source_uid)` 唯一约束 upsert；或者同日先清理 `status=0` 的旧数据再插入（不如 upsert 稳定）

## API 设计（云端）

- 系统库：沿用现有 topic 模块读接口 `/topic/recommendations`；生成由 Celery Beat 定时跑
- 用户库：新增（项目作用域）
  - `GET /api/v1/projects/<project_id>/topics`
  - `POST /api/v1/projects/<project_id>/topics/sync`（批量 upsert，server_version 递增）

## 同步设计（桌面 ↔ 云端）

参考现有策略：

- 云端历史原因使用 int 主键
- 桌面端使用 UUID 作为本地主键以支持离线创建

`project_topics` 同步策略：

- 本地主键：UUID（TEXT）
- 云端主键：int（BigInt）
- 本地维护 `cloud_id` 映射云端 id
- Push：按 `sync_status='pending'` 扫描待同步记录，调用云端 `sync_upsert`
- Pull：拉取项目下 topics 列表，写入本地并维护 `cloud_id`

## 可观测性与安全

- 记录每次生成批次的统计信息（行业数、topic 数、失败原因）
- Provider/LLM 失败要可降级（newsnow 或 mock），并确保任务整体可完成
- 不在日志中打印密钥/完整热点原文（source_info 可存必要元数据与截断内容）

\*/
