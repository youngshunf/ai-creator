# 创流 (CreatorFlow) - 系统架构

> 让创作自然流淌 | 版本: v2.3 | 更新: 2025-12-27

## 1. 产品概述

### 1.1 产品愿景

**成为每一位创作者的 AI 超级大脑** - 从灵感到变现的全链路AI助手

### 1.2 核心功能模块

| 模块 | 功能描述 |
|------|----------|
| **创作** | AI文章生成、图片生成、视频脚本、智能排版、自动配图 |
| **管理** | 素材库、想法库、知识库、作品管理 |
| **发布** | 多平台一键发布、定时发布、批量发布 |
| **运营** | 数据采集、数据分析、AI选题建议、趋势追踪 |
| **LLM管理** | 供应商管理、模型配置、模型组、速率限制、API Key管理、用量统计 |

### 1.3 目标用户

- 个人自媒体创作者（初级→专业）
- MCN机构/团队
- 企业新媒体运营

### 1.4 核心差异化

- **AI Agent深度集成**: 通过Claude Agent SDK / LangGraph实现智能创作工作流
- **端云能力对等**: 桌面端和云端提供完全相同的功能
- **浏览器自动化**: Playwright实现多平台自动发布
- **凭证三轨制**: 本地凭证(默认) / 凭证同步 / OAuth托管，用户自主选择
- **舆情分析**: BettaFish 集成实现热点追踪和爆款预测

### 1.5 关键决策

| 决策项 | 结论 |
|--------|------|
| 目标市场 | 国内优先 |
| 视频能力 | 初期轻度辅助，后期AI剪辑 |
| 团队规模 | 20人 |
| 端侧AI | 不需要本地模型，调用云端API |
| 发布策略 | 官方API优先 → 浏览器自动化 → 半自动辅助 |
| 云端框架 | fastapi_best_architecture |
| 消息队列 | Redis (broker + cache 统一) |

---

## 2. 技术栈选型

### 2.1 客户端框架

#### 桌面端

| 方案 | Python集成 | 原生能力 | 开发效率 | 包体积 |
|------|-----------|---------|---------|--------|
| **Tauri 2.0 + Sidecar** ✅ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | 80-120MB |
| Electron + Python | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 200MB+ |
| PyQt/PySide6 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 120MB+ |

**桌面端选择**: **Tauri 2.0 + Python Sidecar (内嵌Python)**

**选择理由**:

1. 原生能力强：Rust后端直接调用系统API
2. Python Sidecar：官方支持外部进程管理
3. 内嵌Python：打包完整Python环境，不依赖用户系统
4. 体积可控：含Python约80-120MB，仍小于Electron方案
5. 安全性：比Electron更安全的IPC模型
6. 专注桌面：不需要兼顾移动端，架构更简洁

#### 移动端

| 方案 | 跨平台 | 原生能力 | 开发效率 | 生态成熟度 |
|------|--------|---------|---------|-----------|
| **uni-app x** ✅ | iOS + Android + 小程序 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| Flutter | iOS + Android | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| React Native | iOS + Android | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| Tauri Mobile | iOS + Android | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ |

**移动端选择**: **uni-app x (UTS)**

**选择理由**:

1. 国内生态成熟：插件丰富，文档完善
2. 多端发布：一套代码同时发布 iOS/Android/微信小程序
3. 原生性能：UTS 编译为原生代码，无 WebView 性能损耗
4. 纯云端模式：移动端不需要本地能力，uni-app x 完全满足
5. 开发效率：Vue 语法，上手快

### 2.2 云端技术栈

```yaml
框架:
  - FastAPI: 基于 fastapi_best_architecture
  - SQLAlchemy 2.0: ORM
  - Pydantic v2: 数据验证
  - Celery: 异步任务队列

存储:
  - PostgreSQL: 核心业务数据
  - Redis: 缓存 + Celery Broker (统一)
  - MinIO/S3: 媒体文件存储
  - Meilisearch: 全文搜索

浏览器服务:
  - Playwright: 浏览器自动化
  - Docker/K8s: 容器化部署 + 资源隔离
  - 浏览器池: 多实例管理 + 熔断降级

AI基础设施:
  - Claude API: 主力LLM
  - LangGraph: Agent工作流
  - ComfyUI API: 图像生成
  - LLM Gateway: 统一模型网关（多供应商、熔断、限流）

舆情分析:
  - BettaFish: 热点追踪 + 情感分析
  - MindSpider: 社交媒体数据采集
```

### 2.3 Monorepo 代码共享策略

**核心目标**: Graph/Agent 代码「唯一来源」，端云统一执行

```yaml
代码共享原则:
  - 单一来源: Graph 定义文件版本控制，端侧和云端共享同一份代码
  - 端云对等: 相同的 Graph 在本地或云端执行，行为一致
  - 工具隔离: 工具层屏蔽平台差异，通过能力声明和降级路径处理
  - 资源统一: 统一资源 URI 方案，避免硬编码路径
```

#### 项目目录结构

```text
ai-creator/                              # Monorepo 根目录
├── pyproject.toml                       # Python Workspace 定义 (uv)
├── pnpm-workspace.yaml                  # Node.js Workspace 定义 (pnpm)
├── uv.lock                              # Python 依赖锁定
├── .gitmodules                          # Git Submodule 配置
│
├── packages/                            # 共享包目录 (Monorepo 管理)
│   └── agent-core/                      # 核心共享包
│       ├── pyproject.toml               # 包定义
│       └── src/
│           └── agent_core/              # Python 包
│               ├── __init__.py
│               ├── graph/               # Graph 加载/编译
│               ├── runtime/             # 运行时接口
│               ├── tools/               # 工具层基类
│               ├── resource/            # 资源管理
│               ├── crypto/              # 加密工具
│               ├── llm/                 # LLM 客户端
│               └── platforms/           # 平台适配器
│
├── apps/                                # 应用目录 (Monorepo 管理)
│   ├── desktop/                         # Tauri 桌面应用
│   │   ├── src/                         # React 前端
│   │   └── src-tauri/
│   │       ├── src/                     # Rust 后端
│   │       └── sidecar/                 # Sidecar 二进制
│   │
│   ├── sidecar/                         # 桌面端 Python Sidecar
│   │   ├── pyproject.toml               # 依赖 agent-core
│   │   └── src/sidecar/
│   │       ├── main.py                  # JSON-RPC 服务入口
│   │       ├── executor.py              # LocalExecutor
│   │       ├── tools/                   # 本地工具实现
│   │       └── services/                # 本地服务
│   │
│   └── landing/                         # 落地页 (静态站点)
│
├── services/                            # 独立服务 (Git Submodule)
│   ├── cloud-backend/                   # FastAPI 云端后端
│   │   └── git@github.com:youngshunf/ai-clound-backend.git
│   │
│   ├── cloud-frontend/                  # Vue 云端管理后台
│   │   └── git@github.com:youngshunf/ai-clound-frontend.git
│   │
│   ├── mobile-app/                      # uni-app x 移动端
│   │   └── git@github.com:youngshunf/ai-creator-app.git
│   │
│   └── new-api/                         # Go LLM API 网关
│       └── git@github.com:QuantumNous/new-api.git
│
├── external/                            # 外部项目 (Git Submodule)
│   ├── BettaFish/                       # 舆情分析系统
│   │   └── git@github.com:666ghj/BettaFish.git
│   │
│   └── MiroFish/                        # 数据采集系统
│       └── git@github.com:666ghj/MiroFish.git
│
├── agent-definitions/                   # Graph 定义（共享）
│   ├── content-creation.yaml            # 内容创作 Graph
│   ├── publish-workflow.yaml            # 发布工作流 Graph
│   ├── viral-content.yaml               # 爆款内容 Graph
│   └── analytics.yaml                   # 数据分析 Graph
│
└── docs/                                # 项目文档
```

#### Workspace 配置

```toml
# ai-creator/pyproject.toml (Monorepo 根)

[project]
name = "ai-creator-workspace"
version = "0.1.0"
requires-python = ">=3.11"

[tool.uv]
# 定义 workspace 成员
workspace = { members = ["packages/*", "apps/*"] }

[tool.uv.sources]
# 本地包源定义（所有 workspace 成员自动可用）
agent-core = { workspace = true }
```

#### 三层架构

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Agent Runtime 三层架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │              Layer 1: Agent Definition Layer (Graph 定义层)           │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  YAML/JSON 声明式 Graph 定义 (唯一来源，版本控制)                  │  │  │
│  │  │  agent-definitions/*.yaml                                       │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                                      │ GraphLoader.load()                   │
│                                      ▼                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │              Layer 2: Agent Runtime Layer (执行器层)                  │  │
│  │                                                                       │  │
│  │       ┌─────────────────┐              ┌─────────────────┐           │  │
│  │       │  LocalExecutor  │              │  CloudExecutor  │           │  │
│  │       │  (桌面端/Python) │              │  (云端/FastAPI) │           │  │
│  │       └────────┬────────┘              └────────┬────────┘           │  │
│  │                │                                │                    │  │
│  │                └────────────┬───────────────────┘                    │  │
│  │                             │ ToolRegistry.get(tool_name)            │  │
│  │                             ▼                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │              Layer 3: Tool Layer (工具层)                             │  │
│  │                                                                       │  │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐          │  │
│  │  │ ToolInterface  │  │ ToolInterface  │  │ ToolInterface  │          │  │
│  │  │ (统一接口)      │  │ (统一接口)      │  │ (统一接口)      │          │  │
│  │  └───────┬────────┘  └───────┬────────┘  └───────┬────────┘          │  │
│  │          │                   │                   │                   │  │
│  │   ┌──────┴──────┐     ┌──────┴──────┐     ┌──────┴──────┐            │  │
│  │   │ Local Impl  │     │ Cloud Impl  │     │ Mock Impl   │            │  │
│  │   │ (本地实现)   │     │ (云端实现)   │     │ (测试实现)   │            │  │
│  │   └─────────────┘     └─────────────┘     └─────────────┘            │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 工具注册机制

```python
# 工具按运行时类型注册
from agent_core.tools.registry import ToolRegistry
from agent_core.runtime.interfaces import RuntimeType

# 端云共用工具
@ToolRegistry.register_universal("llm_generate")
class LLMGenerateTool(ToolInterface):
    """LLM 工具 - 端云共用"""
    pass

# 本地专用工具
@ToolRegistry.register("browser_publish", RuntimeType.LOCAL)
class LocalBrowserPublishTool(ToolInterface):
    """本地浏览器发布 - 仅桌面端"""
    pass

# 云端专用工具
@ToolRegistry.register("browser_publish", RuntimeType.CLOUD)
class CloudBrowserPublishTool(ToolInterface):
    """云端浏览器发布 - 使用浏览器池"""
    pass
```

---

## 3. 端云分离架构

### 3.1 设计理念

**核心转变**: 桌面端和移动端采用不同技术栈，各自发挥优势

```yaml
桌面端 (Tauri 2.0):
  定位: 完整功能 + 本地能力
  特点:
    - Python Sidecar 支持本地 Agent 执行
    - Playwright 本地浏览器自动化
    - 本地凭证加密存储
    - 离线能力完整
  优势: 性能最优，隐私最强

移动端 (uni-app x):
  定位: 轻量级 + 纯云端
  特点:
    - 无本地 Python 环境
    - 所有 Agent 执行通过云端
    - 素材采集（拍照、录音）
    - 离线草稿 + 云端同步
  优势: 多端发布，开发效率高
```

### 3.2 架构总览

```text
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                      客户端层                                                │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  ┌─────────────────────────────────────────────┐   ┌─────────────────────────────────────┐ │
│  │           桌面端 (Tauri 2.0)                 │   │         移动端 (uni-app x)          │ │
│  │                                             │   │                                     │ │
│  │  ┌─────────────────────────────────────┐   │   │  ┌─────────────────────────────┐   │ │
│  │  │          前端 UI (React)             │   │   │  │    前端 UI (Vue 3 + UTS)    │   │ │
│  │  │  ┌────────┐ ┌────────┐ ┌────────┐   │   │   │  │  ┌──────┐ ┌──────┐ ┌──────┐│   │ │
│  │  │  │创作工作台│ │发布中心│ │数据看板 │   │   │   │  │  │快速记录│ │素材采集│ │数据概览││   │ │
│  │  │  └────────┘ └────────┘ └────────┘   │   │   │  │  └──────┘ └──────┘ └──────┘│   │ │
│  │  └───────────────────┬─────────────────┘   │   │  └───────────────┬─────────────┘   │ │
│  │                      │ IPC                  │   │                  │ HTTPS          │ │
│  │  ┌───────────────────┴─────────────────┐   │   │                  │                │ │
│  │  │            Rust Core                 │   │   │   ╔═════════════╧═══════════════╗│ │
│  │  │  ┌────────┐ ┌──────────┐ ┌────────┐ │   │   │   ║     纯云端模式              ║│ │
│  │  │  │ 本地DB │ │ Sidecar  │ │ 系统API │ │   │   │   ║  • 无本地 Python           ║│ │
│  │  │  │ SQLite │ │  管理器  │ │ 调用   │ │   │   │   ║  • 无浏览器自动化           ║│ │
│  │  │  └────────┘ └────┬─────┘ └────────┘ │   │   │   ║  • 所有 Agent 云端执行     ║│ │
│  │  └──────────────────┼──────────────────┘   │   │   ╚═════════════════════════════╝│ │
│  │                     │ JSON-RPC              │   │                                   │ │
│  │  ┌──────────────────┴──────────────────┐   │   │   ┌─────────────────────────────┐ │ │
│  │  │         Python Sidecar              │   │   │   │      本地轻量存储           │ │ │
│  │  │  ┌────────────┐  ┌────────────────┐ │   │   │   │  ┌──────────┐ ┌──────────┐ │ │ │
│  │  │  │  Agent     │  │   Playwright   │ │   │   │   │  │ 离线草稿 │ │ 素材缓存 │ │ │ │
│  │  │  │  Runtime   │  │   Browser      │ │   │   │   │  └──────────┘ └──────────┘ │ │ │
│  │  │  └────────────┘  └────────────────┘ │   │   │   └─────────────────────────────┘ │ │
│  │  └─────────────────────────────────────┘   │   │                                   │ │
│  │                                             │   │                                   │ │
│  │  Windows / macOS / Linux                    │   │    iOS / Android / 微信小程序     │ │
│  └────────────────────┬────────────────────────┘   └─────────────────┬─────────────────┘ │
│                       │                                              │                   │
│                       │ 本地优先 或 云端执行                          │ 仅云端执行         │
│                       │                                              │                   │
└───────────────────────┼──────────────────────────────────────────────┼───────────────────┘
                        │                                              │
                        └──────────────────────┬───────────────────────┘
                                               │ HTTPS + SSE/WebSocket
                                               ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                            云端服务 (fastapi_best_architecture)                              │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                               API Gateway (FastAPI)                                     │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                     │ │
│  │  │ 认证鉴权 │ │ 限流熔断 │ │ 请求路由 │ │ 日志追踪 │ │ 事件流   │                     │ │
│  │  │  JWT     │ │ Sentinel │ │ Router   │ │ TraceID  │ │ SSE/WS   │                     │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘                     │ │
│  └────────────────────────────────────┬───────────────────────────────────────────────────┘ │
│                                       │                                                     │
│  ┌────────────────────────────────────┼───────────────────────────────────────────────────┐ │
│  │                            核心业务服务                                                 │ │
│  │  ┌──────────────┐  ┌───────────────┴─────────┐  ┌──────────────┐  ┌──────────────┐    │ │
│  │  │   用户服务   │  │       Agent服务          │  │   发布服务   │  │   同步服务   │    │ │
│  │  │  ┌────────┐ │  │  ┌────────────────────┐ │  │  ┌────────┐ │  │  ┌────────┐  │    │ │
│  │  │  │ 认证   │ │  │  │   Runtime          │ │  │  │ 任务调度│ │  │  │ 凭证同步│  │    │ │
│  │  │  │ 订阅   │ │  │  │  (Graph执行器)     │ │  │  │ 状态管理│ │  │  │ 配置同步│  │    │ │
│  │  │  │ 权限   │ │  │  └────────────────────┘ │  │  │ 结果回调│ │  │  │ 数据同步│  │    │ │
│  │  │  └────────┘ │  │  ┌────────────────────┐ │  │  └────────┘ │  │  └────────┘  │    │ │
│  │  └──────────────┘  │  │ Tool Registry     │ │  └──────────────┘  └──────────────┘    │ │
│  │                    │  │ (能力声明/路由)   │ │                                        │ │
│  │  ┌──────────────┐  │  └────────────────────┘ │  ┌──────────────┐                     │ │
│  │  │ 舆情分析服务 │  │  ┌────────────────────┐ │  │ 内容生成服务 │                     │ │
│  │  │  ┌────────┐ │  │  │ 成本账本           │ │  │  ┌────────┐ │                     │ │
│  │  │  │BettaFish│ │  │  │ (预算/Token)       │ │  │  │ ComfyUI│ │                     │ │
│  │  │  │ 热点追踪│ │  │  └────────────────────┘ │  │  │ 图片生成│ │                     │ │
│  │  │  │ 情感分析│ │  └─────────────────────────┘  │  └────────┘ │                     │ │
│  │  │  └────────┘ │                               └──────────────┘                      │ │
│  │  └──────────────┘                                                                     │ │
│  │                                                                                       │ │
│  │  ┌──────────────┐                                                                     │ │
│  │  │  LLM管理服务  │                                                                     │ │
│  │  │  ┌────────┐ │                                                                     │ │
│  │  │  │供应商   │ │                                                                     │ │
│  │  │  │模型配置 │ │                                                                     │ │
│  │  │  │模型组   │ │                                                                     │ │
│  │  │  │速率限制 │ │                                                                     │ │
│  │  │  │API Key │ │                                                                     │ │
│  │  │  │用量统计 │ │                                                                     │ │
│  │  │  │LLM网关  │ │                                                                     │ │
│  │  │  └────────┘ │                                                                     │ │
│  │  └──────────────┘                                                                     │ │
│  └────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                     浏览器自动化服务集群 (隔离 + 熔断)                                   │ │
│  │  ┌───────────────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                    浏览器池管理器 (Browser Pool Manager)                           │ │ │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │ │ │
│  │  │  │ 实例调度     │  │ 健康检查     │  │ 熔断降级     │  │ 自动扩缩容   │          │ │ │
│  │  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘          │ │ │
│  │  └─────────────────────────────────┬─────────────────────────────────────────────────┘ │ │
│  │  ┌──────────────┬──────────────┬───┴───────┬──────────────┬──────────────┐            │ │
│  │  │ Worker Pod 1 │ Worker Pod 2 │ Worker 3  │ Worker Pod 4 │ Worker Pod N │            │ │
│  │  │ ┌──────────┐ │ ┌──────────┐ │┌────────┐ │ ┌──────────┐ │ ┌──────────┐ │            │ │
│  │  │ │Playwright│ │ │Playwright│ ││Playwr..│ │ │Playwright│ │ │Playwright│ │            │ │
│  │  │ │ 容器隔离 │ │ │ 容器隔离 │ ││容器隔离│ │ │ 容器隔离 │ │ │ 容器隔离 │ │            │ │
│  │  │ └──────────┘ │ └──────────┘ │└────────┘ │ └──────────┘ │ └──────────┘ │            │ │
│  │  └──────────────┴──────────────┴───────────┴──────────────┴──────────────┘            │ │
│  └────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              基础设施层 (Redis 统一)                                    │ │
│  │  ┌──────────┐ ┌────────────────────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │ │
│  │  │PostgreSQL│ │        Redis           │ │  MinIO   │ │ Celery   │ │Meilisearch│      │ │
│  │  │  主数据  │ │ 缓存 + Broker + Session│ │ 媒体存储 │ │ Worker   │ │ 全文搜索 │       │ │
│  │  └──────────┘ └────────────────────────┘ └──────────┘ └──────────┘ └──────────┘       │ │
│  └────────────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 桌面端 vs 移动端对比

| 能力 | 桌面端 (Tauri) | 移动端 (uni-app x) |
|------|---------------|-------------------|
| **技术栈** | Tauri 2.0 + React + Rust | uni-app x + Vue 3 + UTS |
| **Python Sidecar** | ✅ 本地运行 | ❌ 不支持 |
| **浏览器自动化** | ✅ 本地Playwright | ☁️ 云端执行 |
| **AI Agent** | ✅ 本地/云端可选 | ☁️ 仅云端 |
| **定时任务** | ✅ 本地APScheduler | ☁️ 云端调度 |
| **数据存储** | ✅ 本地SQLite | ✅ 本地 + 云端同步 |
| **素材采集** | ✅ 文件系统 | ✅ 相机/相册/录音 |
| **离线使用** | ✅ 完整功能 | ⚠️ 仅草稿/缓存 |
| **发布平台** | iOS/Android/小程序 | Windows/macOS/Linux |

### 3.4 进程通信架构

```text
桌面端进程通信:

┌─────────────┐      IPC       ┌─────────────┐    JSON-RPC    ┌─────────────┐
│   WebView   │ ◄────────────► │  Rust Core  │ ◄────────────► │   Python    │
│  (前端UI)   │  Tauri Commands│  (主进程)    │   over stdio   │  (Sidecar)  │
└─────────────┘                └─────────────┘                └─────────────┘
                                     │
                                     │ 系统调用
                                     ▼
                              ┌─────────────┐
                              │   OS API    │
                              │ 文件/网络/  │
                              │ 通知/托盘   │
                              └─────────────┘

移动端通信 (uni-app x):

┌─────────────┐     HTTPS      ┌─────────────┐    内部调用    ┌─────────────┐
│  移动端App  │ ◄────────────► │  API Gateway │ ◄────────────► │  Agent服务  │
│ (Vue + UTS) │   REST + SSE   │  (FastAPI)   │                │  (Runtime)  │
└─────────────┘                └──────┬──────┘                └──────┬──────┘
       ▲                              │                               │
       │                              │ 事件推送                       ▼
       │         ┌────────────────────┴────────────────────┐   ┌─────────────┐
       └─────────│ SSE 事件流                              │   │ Tool Registry│
                 │ - node_started                          │   │ 浏览器服务   │
                 │ - tool_called                           │   │ (Playwright) │
                 │ - run_completed                         │   └─────────────┘
                 └─────────────────────────────────────────┘
```

---

## 4. 凭证安全策略 (三轨制)

### 4.1 凭证模型

```yaml
模式一: 本地凭证 (默认模式)
  存储位置: 桌面端本地加密存储
  加密方式: AES-256-GCM + PBKDF2 (用户主密钥)
  云端状态: 无任何凭证数据
  适用场景:
    - 本地浏览器自动化发布
    - 本地数据采集
    - 隐私敏感用户
  执行方式: 仅桌面端本地执行
  安全等级: 最高

模式二: 凭证同步 (可选模式)
  存储位置: 云端加密存储
  同步内容:
    - 加密后的平台凭证 (Cookies/Token)
    - 用户主密钥 (用于云端解密)
  加密方式:
    - 传输层: TLS 1.3
    - 存储层: AES-256-GCM (云端托管密钥 + 用户密钥派生)
  适用场景:
    - 需要云端自动执行的定时发布
    - 移动端触发发布操作
    - 多设备凭证共享
  执行方式: 云端可代替本地执行所有发布操作
  安全措施:
    - 全链路审计日志
    - 一键撤销同步 (清除云端所有凭证)
    - 凭证访问告警
    - 异常操作检测
  安全等级: 中高 (可控风险)

模式三: 云端OAuth托管 (可选模式)
  存储位置: 云端安全存储
  托管内容: 仅限支持 OAuth 的平台 Refresh Token
  适用场景:
    - 支持 OAuth 的平台 (微信公众号、微博等)
    - 不想同步本地凭证的用户
  执行方式: 云端通过 OAuth API 发布
  安全措施:
    - 全链路审计日志
    - 一键撤销授权
    - Token 定期轮换
    - 操作二次确认
  安全等级: 中高 (OAuth 标准安全)
```

### 4.2 模式对比

| 特性 | 本地凭证 | 凭证同步 | OAuth托管 |
|------|---------|---------|-----------|
| 云端可执行发布 | ❌ | ✅ | ✅ |
| 定时发布支持 | ❌ | ✅ | ✅ |
| 移动端发布 | ❌ | ✅ | ✅ |
| 支持所有平台 | ✅ | ✅ | ❌ 仅OAuth平台 |
| 凭证存储位置 | 本地 | 云端(加密) | 云端(Token) |
| 用户可撤销 | N/A | ✅ 一键清除 | ✅ 一键撤销 |
| 安全等级 | 最高 | 中高 | 中高 |

---

## 5. 智能路由策略

### 5.1 路由决策维度

```yaml
四维路由决策:

  预算维度 (Budget):
    - max_cost_cents: 单次执行最大成本(分)
    - max_tokens: 最大 Token 消耗
    - max_steps: 最大执行步数
    - 超出预算: 中断执行或降级

  队列维度 (Queue):
    - queue_length: 云端当前排队长度
    - estimated_wait: 预估等待时间
    - user_concurrency: 用户并发配额剩余
    - 拥塞时: 优先本地执行

  风控维度 (Risk):
    - risk_level: 操作风险等级 (low/medium/high/critical)
    - 发布/抓取: 高风险，需要审计
    - 账号操作: 最高风险，需要确认
    - 高风险操作: 优先本地或需要确认

  能力维度 (Capability):
    - local_tools: 本地可用工具集
    - cloud_tools: 云端可用工具集
    - tool_fallback: 工具降级路径
    - 能力不足: 自动切换环境或降级
```

### 5.2 路由算法

```python
class RuntimeRouter:
    """智能路由器"""

    def route(self, request: ExecutionRequest, ctx: RoutingContext) -> RoutingDecision:
        """综合决策执行环境"""

        # 1. 移动端强制云端
        if ctx.device_type == "mobile":
            return self._route_cloud(request, ctx)

        # 2. 关键操作优先本地
        if ctx.risk_level == RiskLevel.CRITICAL:
            if ctx.has_local_sidecar:
                return self._route_local(request, ctx)
            return RoutingDecision(
                runtime=RuntimeType.CLOUD,
                requires_confirmation=True,  # 需要用户确认
            )

        # 3. 预算检查
        estimated_cost = self._estimate_cost(request)
        if estimated_cost > ctx.budget.max_cost_cents:
            return RoutingDecision(
                runtime=RuntimeType.LOCAL if ctx.has_local_sidecar else RuntimeType.CLOUD,
                budget_warning=True,
                estimated_cost=estimated_cost,
            )

        # 4. 队列拥塞检查
        if ctx.queue_state.estimated_wait_seconds > 60:
            if ctx.has_local_sidecar and self._can_run_locally(request, ctx):
                return self._route_local(request, ctx)

        # 5. 能力匹配
        if not self._can_run_locally(request, ctx) and ctx.has_local_sidecar:
            return self._route_cloud(request, ctx)

        # 6. 默认本地优先
        if ctx.has_local_sidecar:
            return self._route_local(request, ctx)

        return self._route_cloud(request, ctx)
```

---

## 6. 事件流标准化

### 6.1 事件类型

```python
class EventType(str, Enum):
    """统一事件类型"""
    # 执行生命周期
    RUN_STARTED = "run_started"
    RUN_COMPLETED = "run_completed"
    RUN_FAILED = "run_failed"

    # 节点执行
    NODE_STARTED = "node_started"
    NODE_COMPLETED = "node_completed"

    # 工具调用
    TOOL_CALLED = "tool_called"
    TOOL_RESULT = "tool_result"

    # 人机交互
    HUMAN_REQUIRED = "human_required"
    HUMAN_RESPONDED = "human_responded"

    # 预算与成本
    BUDGET_WARNING = "budget_warning"
    COST_UPDATE = "cost_update"
```

### 6.2 事件流 API

```python
# SSE 端点
@router.get("/agent/run/{run_id}/events")
async def stream_events(run_id: str):
    """SSE 事件流"""
    async def event_generator():
        async for event in event_store.subscribe(run_id):
            yield {
                "event": event.event_type.value,
                "data": json.dumps(event.to_dict()),
            }
    return EventSourceResponse(event_generator())
```

---

## 7. 可观测性

### 7.1 追踪标识

```yaml
追踪标识体系:
  trace_id: 全局追踪ID，贯穿端到端
  run_id: 单次 Graph 执行ID
  span_id: 单个节点/工具执行ID

传播规则:
  - trace_id 从客户端生成，传递到云端
  - run_id 在 Graph 执行开始时生成
  - span_id 在每个节点/工具执行时生成
  - 所有日志、事件必须携带 trace_id

格式:
  trace_id: "tr-{uuid}"
  run_id: "run-{uuid}"
  span_id: "sp-{uuid}"
```

### 7.2 成本账本

```python
@dataclass
class CostLedger:
    """成本账本"""
    run_id: str
    user_id: str
    graph_name: str
    model: str
    input_tokens: int
    output_tokens: int
    estimated_cost_cents: int
    actual_cost_cents: int
    started_at: datetime
    completed_at: datetime
    status: str  # success | failed | cancelled
```

---

## 8. 统一资源 URI

### 8.1 URI 格式

```yaml
格式: asset://{runtime}/{type}/{id}

runtime:
  - local: 本地资源
  - cloud: 云端资源

type:
  - image: 图片资源
  - video: 视频资源
  - credential: 凭证数据
  - temp: 临时文件
  - storage: 用户存储

示例:
  - asset://local/image/abc123
  - asset://cloud/image/xyz789
  - asset://local/credential/xiaohongshu_user1
```

### 8.2 使用原则

```yaml
禁止:
  - 在代码中硬编码绝对路径
  - 在 Graph 输出中使用本地路径
  - 跨运行时直接引用资源

必须:
  - 所有资源引用使用 asset:// URI
  - 通过 AssetResolver 解析实际路径
  - 跨运行时资源需要先上传/下载
```

---

## 9. 浏览器服务约束

### 9.1 生产级约束

```yaml
资源隔离:
  容器化: 每个 Worker 独立 Docker 容器
  CPU限制: 单容器最大 2 核
  内存限制: 单容器最大 2GB
  网络隔离: 限制出站网络

超时控制:
  页面加载: 30s 硬超时
  操作执行: 60s 硬超时
  总执行时间: 5min 硬超时

并发限制:
  用户级: 单用户最大 3 并发
  平台级: 单平台最大 10 并发
  机器级: 单 Worker 最大 5 实例

熔断策略:
  失败阈值: 连续 3 次失败触发熔断
  熔断时间: 5 分钟
  降级方案: 自动切换到"半自动发布"
```

---

## 10. 开发计划概要

### Phase 1: 基础框架 (Month 1-2)

- Tauri 桌面端项目搭建
- Python Sidecar 架构
- 云端服务框架 (Redis 统一)
- uni-app x 移动端项目初始化
- 基础通信实现

### Phase 2: 核心功能 (Month 3-4)

- Agent Runtime + Tool Registry
- 平台适配器开发
- 智能路由实现
- 成本账本系统
- 发布功能实现

### Phase 3: 增强功能 (Month 5-6)

- 更多平台支持
- BettaFish 舆情分析集成
- 移动端完善 (iOS/Android/小程序)
- 商业化功能
- 可观测性完善

---

## 相关文档

- [品牌愿景](./00-品牌愿景.md)
- [桌面端设计](./02-桌面端设计.md)
- [移动端设计](./03-移动端设计.md)
- [云端服务设计](./04-云端服务设计.md)
- [Agent Runtime](./05-Agent-Runtime.md)
- [BettaFish舆情分析集成](./08-BettaFish舆情分析集成.md)
- [开发规范](./11-开发规范.md)
