# æµè§ˆå™¨è‡ªåŠ¨åŒ–å®ç°è¯„ä¼°æŠ¥å‘Š

> è¯„ä¼°æ—¥æœŸ: 2026-01-10 | ç›®æ ‡: è§£å†³è´¦å·åŒæ­¥å¼¹çª—é—®é¢˜ä¸åçˆ¬è™«æ£€æµ‹

## 1. å½“å‰å®ç°åˆ†æ

### 1.1 ç³»ç»Ÿæ¶æ„è®¾è®¡

æ ¹æ® [01-ç³»ç»Ÿæ¶æ„.md](file:///Users/mac/saas/ai-creator/docs/01-ç³»ç»Ÿæ¶æ„.md) çš„è®¾è®¡:

```yaml
å‘å¸ƒç­–ç•¥: å®˜æ–¹APIä¼˜å…ˆ â†’ browser-use AIæµè§ˆå™¨ â†’ åŠè‡ªåŠ¨è¾…åŠ©
æµè§ˆå™¨æœåŠ¡:
  - browser-use: AI Agent ç›´æ¥æ“ä½œè™šæ‹Ÿæµè§ˆå™¨ï¼ˆæ— éœ€é€‰æ‹©å™¨/æµç¨‹è„šæœ¬ï¼‰
  - Docker/K8s: å®¹å™¨åŒ–éƒ¨ç½² + èµ„æºéš”ç¦»
  - æµè§ˆå™¨æ± : å¤šå®ä¾‹ç®¡ç† + ç†”æ–­é™çº§
```

### 1.2 å½“å‰ä»£ç å®ç°

#### æ¡Œé¢ç«¯ Sidecar æµè§ˆå™¨å·¥å…·

| æ–‡ä»¶                                                                                                              | åŠŸèƒ½                    | é—®é¢˜                                          |
| ----------------------------------------------------------------------------------------------------------------- | ----------------------- | --------------------------------------------- |
| [browser.py](file:///Users/mac/saas/ai-creator/apps/sidecar/src/sidecar/tools/browser.py)                         | Playwright åŸºç¡€å‘å¸ƒå·¥å…· | `headless=False` é»˜è®¤å€¼ä¼šå¼¹å‡ºæµè§ˆå™¨           |
| [browser_use_publish.py](file:///Users/mac/saas/ai-creator/apps/sidecar/src/sidecar/tools/browser_use_publish.py) | browser-use AI å‘å¸ƒå™¨   | ä¾èµ– GPT-4oï¼Œæ— åæ£€æµ‹é…ç½®                     |
| [manager.py](file:///Users/mac/saas/ai-creator/apps/sidecar/src/sidecar/browser/manager.py)                       | æµè§ˆå™¨ä¼šè¯ç®¡ç†          | åŸºç¡€åæ£€æµ‹è„šæœ¬è¿‡äºç®€å•                        |
| [fingerprint.py](file:///Users/mac/saas/ai-creator/apps/sidecar/src/sidecar/browser/fingerprint.py)               | æŒ‡çº¹ç”Ÿæˆå™¨              | ç¼ºå°‘é«˜çº§æŒ‡çº¹ï¼ˆCanvasã€WebGLã€AudioContextï¼‰   |
| [account_sync.py](file:///Users/mac/saas/ai-creator/apps/sidecar/src/sidecar/services/account_sync.py)            | è´¦å·åŒæ­¥æœåŠ¡            | **`headless=False` ç¡¬ç¼–ç ï¼Œç›´æ¥å¯¼è‡´å¼¹çª—é—®é¢˜** |

#### å…³é”®é—®é¢˜ä»£ç 

```python
# account_sync.py:46 - è´¦å·åŒæ­¥æœåŠ¡å¼ºåˆ¶ä½¿ç”¨éæ— å¤´æ¨¡å¼
browser_manager = BrowserSessionManager(headless=False)
```

```python
# manager.py:258-280 - åæ£€æµ‹è„šæœ¬è¿‡äºç®€å•
async def _inject_stealth_scripts(self, context):
    await context.add_init_script("""
        // éšè— webdriver å±æ€§
        Object.defineProperty(navigator, 'webdriver', {
            get: () => undefined
        });
        // ... ä»…å‡ è¡ŒåŸºç¡€ä»£ç 
    """)
```

### 1.3 é—®é¢˜æ€»ç»“

```mermaid
graph TD
    A[è´¦å·åŒæ­¥è§¦å‘] --> B[BrowserSessionManager]
    B --> C{headless=False}
    C -->|ç¡¬ç¼–ç | D[æµè§ˆå™¨çª—å£å¼¹å‡º]
    D --> E[ç”¨æˆ·å¯è§]

    B --> F[åŸºç¡€åæ£€æµ‹è„šæœ¬]
    F --> G[å¹³å°åçˆ¬è™«æ£€æµ‹]
    G --> H[åŒæ­¥å¤±è´¥]

    style C fill:#f66,stroke:#333
    style G fill:#f66,stroke:#333
```

---

## 2. åçˆ¬è™«æ£€æµ‹åŸç†

### 2.1 ä¸»æµå¹³å°æ£€æµ‹æ‰‹æ®µ

| æ£€æµ‹ç»´åº¦           | æ£€æµ‹å†…å®¹                     | å½“å‰å®ç°çŠ¶æ€                       |
| ------------------ | ---------------------------- | ---------------------------------- |
| **WebDriver æ£€æµ‹** | `navigator.webdriver` å±æ€§   | âœ… å·²éšè—                          |
| **è‡ªåŠ¨åŒ–æ ‡è®°**     | Chrome è‡ªåŠ¨åŒ–æ ‡è®°            | âœ… ä½¿ç”¨ `--disable-blink-features` |
| **æµè§ˆå™¨æŒ‡çº¹**     | Canvasã€WebGLã€AudioContext  | âŒ æœªå¤„ç†                          |
| **è¡Œä¸ºåˆ†æ**       | é¼ æ ‡è½¨è¿¹ã€æ‰“å­—é€Ÿåº¦ã€é¡µé¢åœç•™ | âŒ æœªå®ç°                          |
| **CDP æ£€æµ‹**       | DevTools åè®®ç‰¹å¾            | âŒ æœªå¤„ç†                          |
| **Headless æ£€æµ‹**  | æ— å¤´æµè§ˆå™¨ç‰¹å¾               | âš ï¸ éƒ¨åˆ†å¤„ç†                        |
| **IP/åœ°ç†ä½ç½®**    | ä»£ç† IP è´¨é‡                 | âŒ æœªé…ç½®                          |
| **Cookie/Session** | ç™»å½•æ€æœ‰æ•ˆæ€§                 | âœ… å·²å®ç°                          |

### 2.2 ä¸ºä½• Headless æ¨¡å¼è¢«æ£€æµ‹

```javascript
// å¹³å°å¸¸ç”¨æ£€æµ‹ä»£ç 
const isHeadless = () => {
  // 1. Chrome ç‰ˆæœ¬ä¸­çš„ HeadlessChrome æ ‡è®°
  if (/HeadlessChrome/.test(navigator.userAgent)) return true;

  // 2. WebGL æ¸²æŸ“å™¨
  const canvas = document.createElement("canvas");
  const gl = canvas.getContext("webgl");
  const renderer = gl.getParameter(gl.RENDERER);
  if (renderer.includes("SwiftShader")) return true;

  // 3. CDP ç‰¹å¾
  if (window.chrome && !window.chrome.app) return true;

  // 4. æ’ä»¶æ•°é‡
  if (navigator.plugins.length === 0) return true;

  return false;
};
```

---

## 3. è§£å†³æ–¹æ¡ˆå¯¹æ¯”

### 3.1 æ–¹æ¡ˆå¯¹æ¯”è¡¨

| æ–¹æ¡ˆ                              | é™é»˜è¿è¡Œ | åæ£€æµ‹èƒ½åŠ› | å®ç°éš¾åº¦ | æˆæœ¬ |  æ¨èæŒ‡æ•°  |
| --------------------------------- | :------: | :--------: | :------: | :--: | :--------: |
| **A: å¢å¼º Playwright Stealth**    |    âœ…    |   â­â­â­   |    ä½    | å…è´¹ |   â­â­â­   |
| **B: ä½¿ç”¨ Undetected Playwright** |    âœ…    |  â­â­â­â­  |    ä¸­    | å…è´¹ |  â­â­â­â­  |
| **C: CDP è¿æ¥ç”¨æˆ·çœŸå®æµè§ˆå™¨**     |    âœ…    | â­â­â­â­â­ |    ä¸­    | å…è´¹ | â­â­â­â­â­ |
| **D: å•†ä¸šåæ£€æµ‹æµè§ˆå™¨**           |    âœ…    | â­â­â­â­â­ |    ä½    | ä»˜è´¹ |  â­â­â­â­  |
| **E: å®˜æ–¹ API ä¼˜å…ˆ**              |    âœ…    |    N/A     |    é«˜    | å…è´¹ |   â­â­â­   |

---

## 4. æ¨èæ–¹æ¡ˆè¯¦è§£

### 4.1 æ–¹æ¡ˆ C: CDP è¿æ¥ç”¨æˆ·çœŸå®æµè§ˆå™¨ (é¦–é€‰æ¨è)

> [!TIP]
> è¿™æ˜¯ç›®å‰æœ€å¯é çš„åæ£€æµ‹æ–¹æ¡ˆï¼ŒMediaCrawler é¡¹ç›®å·²å®ç°ç±»ä¼¼åŠŸèƒ½

#### æ ¸å¿ƒæ€è·¯

```text
ç”¨æˆ·æ—¥å¸¸ä½¿ç”¨çš„ Chrome/Edge
       â”‚
       â”‚ å¯åŠ¨æ—¶é™„åŠ  --remote-debugging-port=9222
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Chrome + CDP   â”‚  â† çœŸå®æµè§ˆå™¨ï¼Œæœ‰å®Œæ•´ç™»å½•æ€ã€æ’ä»¶ã€å†å²
â”‚  (åå°è¿è¡Œ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ WebSocket (CDPåè®®)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Playwright     â”‚  â† é€šè¿‡ CDP è¿æ¥ï¼Œæ— éœ€æ–°å¯åŠ¨æµè§ˆå™¨
â”‚  (æ§åˆ¶ç«¯)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¼˜åŠ¿

1. **é›¶æ£€æµ‹é£é™©**: ä½¿ç”¨ç”¨æˆ·çœŸå®æµè§ˆå™¨ï¼Œæ‹¥æœ‰å®Œæ•´çš„æµè§ˆå†å²ã€æ’ä»¶ã€å­—ä½“
2. **ç™»å½•æ€å¤ç”¨**: ç›´æ¥ä½¿ç”¨ç”¨æˆ·å·²ç™»å½•çš„è´¦å·ï¼Œæ— éœ€é‡æ–°ç™»å½•
3. **ç”¨æˆ·æ— æ„ŸçŸ¥**: æµè§ˆå™¨å¯æœ€å°åŒ–æˆ–éšè—åˆ°æ‰˜ç›˜
4. **é›¶é¢å¤–æˆæœ¬**: æ— éœ€ä»˜è´¹æœåŠ¡

#### å®ç°å‚è€ƒ

é¡¹ç›®ä¸­å·²æœ‰ [cdp_browser.py](file:///Users/mac/saas/ai-creator/external/BettaFish/MindSpider/DeepSentimentCrawling/MediaCrawler/tools/cdp_browser.py) å’Œ [browser_launcher.py](file:///Users/mac/saas/ai-creator/external/BettaFish/MindSpider/DeepSentimentCrawling/MediaCrawler/tools/browser_launcher.py) å¯ç›´æ¥å¤ç”¨ï¼š

```python
# æ ¸å¿ƒä»£ç ç¤ºä¾‹
class CDPBrowserManager:
    async def launch_and_connect(self, playwright, headless=False):
        # 1. æ£€æµ‹ç”¨æˆ·å®‰è£…çš„ Chrome/Edge
        browser_path = self._get_browser_path()

        # 2. å¯åŠ¨æµè§ˆå™¨ï¼ˆå¯é€‰æœ€å°åŒ–ï¼Œæ— éœ€ headlessï¼‰
        args = [
            "--remote-debugging-port=9222",
            "--disable-blink-features=AutomationControlled",
            "--start-minimized",  # ğŸ”¥ æœ€å°åŒ–å¯åŠ¨ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
        ]

        # 3. é€šè¿‡ CDP è¿æ¥
        ws_url = await self._get_websocket_url(9222)
        self.browser = await playwright.chromium.connect_over_cdp(ws_url)
```

#### ç”¨æˆ·æ— æ„ŸçŸ¥çš„å…³é”®é…ç½®

```python
# å¯åŠ¨æµè§ˆå™¨æ—¶çš„å‚æ•°
browser_args = [
    browser_path,
    f"--remote-debugging-port={debug_port}",
    "--no-first-run",
    "--no-default-browser-check",
    "--disable-blink-features=AutomationControlled",
    "--disable-infobars",
    # ğŸ”¥ å…³é”®ï¼šæœ€å°åŒ–å¯åŠ¨
    "--start-minimized",
    # æˆ–è€…ä½¿ç”¨æ— å¤´æ–°æ¨¡å¼ï¼ˆChrome 109+ï¼‰
    # "--headless=new",
]
```

---

### 4.2 æ–¹æ¡ˆ B: Undetected Playwright (å¤‡é€‰)

#### ä½¿ç”¨ playwright-stealth æˆ– undetected-playwright

```bash
pip install playwright-stealth
# æˆ–
pip install undetected-playwright
```

```python
from playwright.async_api import async_playwright
from playwright_stealth import stealth_async

async def create_stealth_browser():
    p = await async_playwright().start()
    browser = await p.chromium.launch(
        headless=True,  # å¯ä»¥ä½¿ç”¨ headless æ¨¡å¼
        args=[
            "--disable-blink-features=AutomationControlled",
            "--disable-dev-shm-usage",
            "--no-sandbox",
        ]
    )
    context = await browser.new_context()
    page = await context.new_page()

    # ğŸ”¥ æ³¨å…¥å®Œæ•´åæ£€æµ‹è„šæœ¬
    await stealth_async(page)

    return browser, page
```

#### playwright-stealth ç‰¹æ€§

- è‡ªåŠ¨ä¼ªè£… `navigator.webdriver`
- æ¨¡æ‹ŸçœŸå® Chrome æ’ä»¶
- å¤„ç† WebGL æŒ‡çº¹
- æ¨¡æ‹ŸçœŸå® Permissions API
- å¤„ç† Chrome.app æ£€æµ‹

---

### 4.3 æ–¹æ¡ˆ A: å¢å¼ºç°æœ‰ä»£ç  (å¿«é€Ÿä¿®å¤)

#### ä¿®æ”¹ 1: è´¦å·åŒæ­¥æœåŠ¡æ”¯æŒé™é»˜æ¨¡å¼

```diff
# apps/sidecar/src/sidecar/services/account_sync.py

class AccountSyncService:
-   async def sync_account(self, platform: str, account_id: str) -> SyncResult:
+   async def sync_account(
+       self,
+       platform: str,
+       account_id: str,
+       headless: bool = True,  # é»˜è®¤é™é»˜æ¨¡å¼
+   ) -> SyncResult:
        browser_manager = None
        try:
-           browser_manager = BrowserSessionManager(headless=False)
+           browser_manager = BrowserSessionManager(headless=headless)
```

#### ä¿®æ”¹ 2: å¢å¼ºåæ£€æµ‹è„šæœ¬

```python
# apps/sidecar/src/sidecar/browser/manager.py

STEALTH_SCRIPT = """
// å®Œæ•´åæ£€æµ‹è„šæœ¬
(function() {
    // 1. éšè— webdriver
    Object.defineProperty(navigator, 'webdriver', {
        get: () => undefined
    });

    // 2. ä¼ªè£… plugins
    Object.defineProperty(navigator, 'plugins', {
        get: () => {
            return [
                { name: 'Chrome PDF Plugin' },
                { name: 'Chrome PDF Viewer' },
                { name: 'Native Client' },
            ];
        }
    });

    // 3. ä¼ªè£… languages
    Object.defineProperty(navigator, 'languages', {
        get: () => ['zh-CN', 'zh', 'en']
    });

    // 4. å¤„ç† permissions
    const originalQuery = window.navigator.permissions.query;
    window.navigator.permissions.query = (parameters) => (
        parameters.name === 'notifications' ?
            Promise.resolve({ state: Notification.permission }) :
            originalQuery(parameters)
    );

    // 5. ä¼ªè£… chrome å¯¹è±¡
    window.chrome = {
        runtime: {},
        loadTimes: function() {},
        csi: function() {},
        app: {}
    };

    // 6. å¤„ç† WebGL æ¸²æŸ“å™¨
    const getParameter = WebGLRenderingContext.prototype.getParameter;
    WebGLRenderingContext.prototype.getParameter = function(parameter) {
        if (parameter === 37445) return 'Intel Inc.';
        if (parameter === 37446) return 'Intel Iris OpenGL Engine';
        return getParameter.call(this, parameter);
    };

    // 7. å¤„ç† headless æ£€æµ‹
    Object.defineProperty(navigator, 'platform', {
        get: () => 'MacIntel'
    });

    // 8. éšè—è‡ªåŠ¨åŒ–æ ‡è®°
    delete window.cdc_adoQpoasnfa76pfcZLmcfl_Array;
    delete window.cdc_adoQpoasnfa76pfcZLmcfl_Promise;
    delete window.cdc_adoQpoasnfa76pfcZLmcfl_Symbol;
})();
"""
```

---

## 5. æ¨èå®æ–½è·¯å¾„

### 5.1 åˆ†é˜¶æ®µå®æ–½

```mermaid
gantt
    title æµè§ˆå™¨è‡ªåŠ¨åŒ–ä¼˜åŒ–è·¯çº¿å›¾
    dateFormat  YYYY-MM-DD
    section ç¬¬ä¸€é˜¶æ®µ (å¿«é€Ÿä¿®å¤)
    ä¿®å¤ headless å‚æ•°        :a1, 2026-01-10, 1d
    å¢å¼ºåæ£€æµ‹è„šæœ¬            :a2, after a1, 2d
    section ç¬¬äºŒé˜¶æ®µ (æ ¸å¿ƒä¼˜åŒ–)
    é›†æˆ playwright-stealth   :b1, after a2, 2d
    å®ç° CDP è¿æ¥æ¨¡å¼         :b2, after b1, 3d
    section ç¬¬ä¸‰é˜¶æ®µ (é«˜çº§åŠŸèƒ½)
    è¡Œä¸ºæ¨¡æ‹Ÿ (é¼ æ ‡/é”®ç›˜)      :c1, after b2, 3d
    ä»£ç† IP è½®æ¢              :c2, after c1, 2d
```

### 5.2 ç«‹å³å¯æ‰§è¡Œçš„ä¿®å¤

1. **ä¿®æ”¹ `headless` å‚æ•°**: å°† `account_sync.py` ä¸­çš„ `headless=False` æ”¹ä¸º `headless=True`
2. **å¢å¼ºåæ£€æµ‹è„šæœ¬**: ä½¿ç”¨ä¸Šè¿°å®Œæ•´çš„ stealth è„šæœ¬æ›¿æ¢ç°æœ‰ç®€å•è„šæœ¬
3. **å®‰è£… playwright-stealth**: `pip install playwright-stealth`

---

## 6. é¢å¤–å»ºè®®

### 6.1 ç”¨æˆ·ä½“éªŒä¼˜åŒ–

| åœºæ™¯     | å½“å‰è¡Œä¸º           | ä¼˜åŒ–å»ºè®®                     |
| -------- | ------------------ | ---------------------------- |
| è´¦å·åŒæ­¥ | å¼¹å‡ºæµè§ˆå™¨çª—å£     | åå°é™é»˜æ‰§è¡Œï¼ŒToast é€šçŸ¥è¿›åº¦ |
| é¦–æ¬¡ç™»å½• | å¿…é¡»å¼¹å‡ºæµè§ˆå™¨æ‰«ç  | å¼¹å‡ºåè‡ªåŠ¨æœ€å°åŒ–åˆ°æ‰˜ç›˜       |
| ä½œå“å‘å¸ƒ | å¯èƒ½å¼¹å‡ºæµè§ˆå™¨     | æ‰˜ç›˜å›¾æ ‡æ˜¾ç¤ºå‘å¸ƒè¿›åº¦         |

### 6.2 å•†ä¸šåæ£€æµ‹æµè§ˆå™¨å‚è€ƒ (æ–¹æ¡ˆ D)

å¦‚æœä»¥ä¸Šæ–¹æ¡ˆä»æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œå¯è€ƒè™‘å•†ä¸šæ–¹æ¡ˆï¼š

| äº§å“           | ç‰¹ç‚¹                   | ä»·æ ¼      |
| -------------- | ---------------------- | --------- |
| **Multilogin** | å¤šè´¦å·éš”ç¦»ï¼Œä¸“ä¸šçº§æŒ‡çº¹ | $99+/æœˆ   |
| **GoLogin**    | æ€§ä»·æ¯”é«˜ï¼ŒAPI æ”¯æŒå¥½   | $49+/æœˆ   |
| **AdsPower**   | å›½å†…å›¢é˜Ÿï¼Œä¸­æ–‡æ”¯æŒ     | Â¥180+/æœˆ  |
| **Nstbrowser** | å…è´¹ç‰ˆå¯ç”¨ï¼Œæ”¯æŒ API   | å…è´¹/ä»˜è´¹ |

### 6.3 å®‰å…¨è€ƒè™‘

> [!CAUTION]
> è¯·ç¡®ä¿ï¼š
>
> - ä¸è¦åœ¨äº‘ç«¯ä½¿ç”¨ç”¨æˆ·æœ¬åœ°å‡­è¯è¿›è¡Œè‡ªåŠ¨åŒ–æ“ä½œï¼Œé™¤éç”¨æˆ·æ˜ç¡®æˆæƒ
> - éµå®ˆå„å¹³å°çš„ä½¿ç”¨æ¡æ¬¾
> - æ§åˆ¶è¯·æ±‚é¢‘ç‡ï¼Œé¿å…å¯¹å¹³å°é€ æˆå‹åŠ›

---

## 7. ç»“è®º

| é—®é¢˜           | æ ¹å›                     | è§£å†³æ–¹æ¡ˆ                                      |
| -------------- | ----------------------- | --------------------------------------------- |
| æµè§ˆå™¨çª—å£å¼¹å‡º | `headless=False` ç¡¬ç¼–ç  | æ”¹ä¸º `headless=True` æˆ–ä½¿ç”¨ CDP æœ€å°åŒ–æ¨¡å¼    |
| åçˆ¬è™«æ£€æµ‹å¤±è´¥ | åæ£€æµ‹è„šæœ¬è¿‡äºç®€å•      | ä½¿ç”¨ playwright-stealth æˆ– CDP è¿æ¥çœŸå®æµè§ˆå™¨ |

**æœ€ç»ˆæ¨è**: é‡‡ç”¨ **æ–¹æ¡ˆ C (CDP è¿æ¥ç”¨æˆ·çœŸå®æµè§ˆå™¨)** ä½œä¸ºä¸»è¦æ–¹æ¡ˆï¼Œé…åˆ **æ–¹æ¡ˆ A (å¢å¼ºåæ£€æµ‹è„šæœ¬)** ä½œä¸º fallbackã€‚

---

## ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ¶æ„](file:///Users/mac/saas/ai-creator/docs/01-ç³»ç»Ÿæ¶æ„.md)
- [MediaCrawler CDP å®ç°](file:///Users/mac/saas/ai-creator/external/BettaFish/MindSpider/DeepSentimentCrawling/MediaCrawler/tools/cdp_browser.py)
- [æµè§ˆå™¨ä¼šè¯ç®¡ç†å™¨](file:///Users/mac/saas/ai-creator/apps/sidecar/src/sidecar/browser/manager.py)
