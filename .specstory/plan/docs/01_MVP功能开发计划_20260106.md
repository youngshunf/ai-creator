# MVP 功能开发计划

> 版本: v1.1 | 日期: 2026-01-06 | 作者: @Ysf

## 一、概述

基于 `docs/14-MVP需求规格.md` 和 `docs/16-数据库设计与同步策略.md`，并行开发 AI 创作、账号管理、发布管理三大模块。

### 关键决策

| 决策项 | 结论 |
|--------|------|
| 开发方式 | 并行开发 |
| 账号登录 | 扫码登录（弹出浏览器窗口） |
| 平台支持 | 所有平台（小红书、微信公众号、抖音等） |
| 发布方式 | browser-use AI 操作浏览器，无需编写选择器 |
| 平台适配器 | 仅适配文章发布规范（标题长度、正文长度等） |
| 数据存储 | 云端 PostgreSQL + 桌面端 SQLite |
| 同步策略 | 云端优先 + 离线优先 + 增量同步 |

### 已完成

- [x] 项目管理模块 (90%)
- [x] 统一接口请求 (`apps/desktop/src/api/request.ts`)
- [x] 基础 UI 框架（路由、布局、组件）
- [x] TipTap 富文本编辑器
- [x] Sidecar JSON-RPC 基础框架

---

## 二、模块开发计划

### 2.1 AI 创作模块 (F-MVP-001 ~ F-MVP-005)

#### 功能清单

| 需求ID | 功能 | 优先级 | 状态 |
|--------|------|--------|------|
| F-MVP-001 | 极简选题 | P0 | 待开发 |
| F-MVP-002 | AI 智能写作 | P0 | 待开发 |
| F-MVP-003 | 内容编辑 | P0 | 已有基础 |
| F-MVP-004 | AI 配图生成 | P0 | 待开发 |
| F-MVP-005 | 智能排版 | P1 | 待开发 |

#### 文件清单

**新建文件**:
- `agent-definitions/topic-suggestion.yaml` - 选题推荐 Graph
- `agent-definitions/image-generation.yaml` - 配图生成 Graph
- `apps/desktop/src/hooks/useTopicSuggestion.ts` - 选题推荐 Hook
- `apps/desktop/src/components/creation/TopicSuggestion.tsx` - 选题推荐组件
- `apps/desktop/src/components/creation/ImageGenerator.tsx` - 配图生成组件

**修改文件**:
- `agent-definitions/content-creation.yaml` - 增加风格参数
- `apps/desktop/src/routes/creation/index.tsx` - 集成新组件
- `apps/desktop/src/components/editor/TipTapEditor.tsx` - 添加格式化功能

---

### 2.2 账号管理模块 (F-MVP-010 ~ F-MVP-013)

#### 功能清单

| 需求ID | 功能 | 优先级 | 状态 |
|--------|------|--------|------|
| F-MVP-010 | 账号添加（扫码登录） | P0 | 待开发 |
| F-MVP-011 | 账号列表 | P0 | 待开发 |
| F-MVP-012 | 状态监控 | P0 | 待开发 |
| F-MVP-013 | 账号删除 | P1 | 待开发 |

#### 扫码登录流程

```
用户点击添加账号 → 选择平台 → Sidecar 启动 Playwright 浏览器
→ 打开平台登录页 → 用户扫码 → 检测登录成功
→ 保存 Cookie/Session → 关闭浏览器 → 更新账号列表
```

#### 文件清单

**新建文件**:
- `apps/desktop/src/stores/useAccountStore.ts` - 账号管理 Store
- `apps/desktop/src/components/accounts/AddAccountDialog.tsx` - 添加账号对话框
- `apps/desktop/src/components/accounts/AccountCard.tsx` - 账号卡片组件

**修改文件**:
- `apps/sidecar/src/sidecar/main.py` - 添加 RPC 方法
- `apps/desktop/src-tauri/src/commands/mod.rs` - 添加 Tauri Commands
- `apps/desktop/src/routes/accounts.tsx` - 改为动态数据

#### Sidecar RPC 方法

```python
# 新增方法
"platform_login": self._handle_platform_login,      # 扫码登录
"get_accounts": self._handle_get_accounts,          # 获取账号列表
"check_account_status": self._handle_check_account_status,  # 检查状态
"delete_account": self._handle_delete_account,      # 删除账号
```

#### Tauri Commands

```rust
platform_login(platform: String) -> PlatformAccount
get_platform_accounts() -> Vec<PlatformAccount>
check_account_status(account_id: String) -> String
delete_platform_account(account_id: String) -> bool
```

---

### 2.3 发布管理模块 (F-MVP-020 ~ F-MVP-023)

#### 功能清单

| 需求ID | 功能 | 优先级 | 状态 |
|--------|------|--------|------|
| F-MVP-020 | 发布配置 | P0 | 待开发 |
| F-MVP-021 | 一键发布 | P0 | 待开发 |
| F-MVP-022 | 发布队列 | P1 | 待开发 |
| F-MVP-023 | 发布结果 | P0 | 待开发 |

#### browser-use AI 发布流程

```
用户选择内容 + 平台 + 账号
        ↓
[内容适配] - 根据平台规范调整内容
        ↓
[启动浏览器] - 加载账号凭证
        ↓
[browser-use AI] - AI 自主操作浏览器完成发布
        ↓
[结果检测] - 判断发布成功/失败
        ↓
[保存记录] - 记录发布结果
```

#### 文件清单

**新建文件**:
- `agent-definitions/publish-workflow.yaml` - 发布 Graph
- `apps/desktop/src/stores/usePublishStore.ts` - 发布管理 Store
- `apps/desktop/src/components/publish/PublishQueue.tsx` - 发布队列组件
- `apps/desktop/src/components/publish/PlatformSelector.tsx` - 平台选择器
- `apps/sidecar/src/sidecar/tools/browser_use_publish.py` - browser-use 发布工具

**修改文件**:
- `apps/sidecar/src/sidecar/main.py` - 添加发布 RPC 方法
- `apps/desktop/src-tauri/src/commands/mod.rs` - 添加发布 Commands
- `apps/desktop/src/routes/publish/index.tsx` - 集成发布功能

#### Sidecar RPC 方法

```python
"publish_content": self._handle_publish_content,    # 发布内容
"get_publish_queue": self._handle_get_publish_queue,  # 获取发布队列
```

#### Tauri Commands

```rust
publish_content(request: PublishRequest) -> PublishResult
batch_publish(requests: Vec<PublishRequest>) -> Vec<PublishResult>
```

---

## 三、平台适配器设计

### 3.1 设计原则

- **仅适配内容规范**：标题长度、正文长度、图片数量等
- **不编写选择器**：发布操作由 browser-use AI 自主完成
- **统一接口**：所有平台实现相同的 `PlatformAdapter` 接口

### 3.2 平台规范

| 平台 | 标题长度 | 正文长度 | 图片数量 | 特殊要求 |
|------|---------|---------|---------|---------|
| 小红书 | ≤20字 | ≤1000字 | 1-9张 | 需要封面图 |
| 微信公众号 | ≤64字 | 无限制 | 无限制 | 支持富文本 |
| 抖音 | ≤30字 | ≤500字 | 1-12张 | 图文/视频 |
| 微博 | ≤140字 | ≤2000字 | 0-9张 | 支持话题 |
| B站 | ≤80字 | ≤10000字 | 1-100张 | 专栏文章 |

### 3.3 适配器接口

```python
class PlatformAdapter:
    platform_name: str
    title_max_length: int
    content_max_length: int
    image_max_count: int

    def adapt_content(self, content: PublishContent) -> AdaptedContent:
        """适配内容到平台规范"""
        pass

    def get_publish_url(self) -> str:
        """获取发布页面 URL"""
        pass
```

---

## 四、数据模型

### 4.1 账号模型

```typescript
interface PlatformAccount {
  id: string;
  platform: 'xiaohongshu' | 'wechat_mp' | 'douyin' | 'weibo' | 'bilibili';
  nickname: string;
  avatar?: string;
  status: 'active' | 'expired' | 'unknown';
  project_id?: string;
  created_at: string;
  updated_at: string;
}
```

### 4.2 发布任务模型

```typescript
interface PublishTask {
  id: string;
  platform: string;
  account_id: string;
  content: PublishContent;
  status: 'pending' | 'publishing' | 'success' | 'failed';
  error?: string;
  post_url?: string;
  created_at: string;
  published_at?: string;
}
```

### 4.3 发布内容模型

```typescript
interface PublishContent {
  title?: string;
  text: string;
  images: string[];
  tags: string[];
}
```

---

## 五、实施步骤

### Phase 0: 数据库基础设施 (Day 1) ✅ 已完成

基于 `docs/16-数据库设计与同步策略.md` 实现本地数据库。

1. [x] 创建桌面端 SQLite Schema
   - `apps/desktop/src-tauri/src/db/schema.sql`
   - 包含: users, projects, platform_accounts, contents, publications
   - 包含: sync_metadata, sync_conflicts, sync_queue

2. [x] 实现 Rust 数据库操作层
   - `apps/desktop/src-tauri/src/db/mod.rs`
   - `apps/desktop/src-tauri/src/db/models.rs`
   - `apps/desktop/src-tauri/src/db/repository.rs`

3. [x] 添加数据库 Tauri Commands
   - 项目 CRUD
   - 账号 CRUD
   - 内容 CRUD
   - 发布任务 CRUD

4. [x] 创建平台适配器
   - `apps/sidecar/src/sidecar/platforms/base.py`
   - `apps/sidecar/src/sidecar/platforms/xiaohongshu.py`
   - `apps/sidecar/src/sidecar/platforms/wechat.py`
   - `apps/sidecar/src/sidecar/platforms/douyin.py`

5. [x] 添加 Sidecar RPC 方法
   - `get_platforms` - 获取平台列表
   - `adapt_content` - 内容适配
   - `start_platform_login` - 启动登录
   - `publish_content` - 发布内容

### Phase 1: 基础设施 (Day 2-3) ✅ 已完成

1. [x] 创建平台适配器基类 (`apps/sidecar/src/sidecar/platforms/`)
2. [x] 实现各平台内容规范适配器
3. [x] 添加 Sidecar RPC 方法框架
4. [x] 添加 Tauri Commands 框架

### Phase 2: 账号管理 (Day 4-5) ✅ 已完成

1. [x] 实现扫码登录流程 (`apps/sidecar/src/sidecar/tools/browser_use_publish.py`)
2. [x] 实现账号列表和状态监控 (`apps/desktop/src/stores/useAccountStore.ts`)
3. [x] 实现凭证加密存储 (`~/.ai-creator/credentials/`)
4. [x] 完善账号管理 UI (`apps/desktop/src/components/accounts/`)

### Phase 3: AI 创作 (Day 6-7) ✅ 已完成

1. [x] 实现选题推荐 Graph 和 UI
   - `agent-definitions/topic-suggestion.yaml`
   - `apps/desktop/src/components/creation/TopicSuggestion.tsx`
2. [x] 增强 AI 写作功能（风格参数）
   - `agent-definitions/content-creation.yaml` - 添加 style, platform, project_context 参数
3. [x] 实现配图生成功能
   - `agent-definitions/image-generation.yaml`
   - `apps/desktop/src/components/creation/ImageGenerator.tsx`
4. [ ] 实现智能排版功能 (P1, 待开发)

### Phase 4: 发布管理 (Day 8-9) ✅ 已完成

1. [x] 实现 browser-use 发布工具
   - `apps/sidecar/src/sidecar/tools/browser_use_publish.py`
2. [x] 实现发布配置 UI
   - `apps/desktop/src/components/publish/PublishCenter.tsx`
3. [x] 实现发布队列和进度展示
   - `apps/desktop/src/components/publish/PublishQueue.tsx`
   - `apps/desktop/src/stores/usePublishStore.ts`
4. [x] 实现发布结果反馈

### Phase 5: 集成测试 (Day 10) ✅ 已完成

1. [x] Rust 编译验证 - 通过（7个未使用代码警告）
2. [x] 前端 TypeScript 构建 - 通过
3. [x] Python 平台适配器验证 - 通过
4. [x] browser-use 发布工具验证 - 通过
5. [ ] 端到端测试：创作 → 发布完整流程（需手动测试）
6. [ ] 多平台发布测试
7. [ ] 错误处理和边界情况测试
8. [ ] 性能优化

---

## 六、关键技术方案

### 6.1 browser-use AI 发布

使用 browser-use 库让 AI 自主操作浏览器完成发布，无需编写特定平台的选择器。

**优势**:
- 无需维护平台选择器（平台 UI 经常变化）
- AI 自主理解页面结构
- 适应性强

**任务描述示例**:
```
请在小红书平台发布以下内容：
1. 导航到发布页面: https://creator.xiaohongshu.com/publish/publish
2. 上传图片: [图片路径列表]
3. 填写标题: [标题内容]
4. 填写正文: [正文内容]
5. 添加话题标签: [标签列表]
6. 点击发布按钮
7. 等待发布成功提示
```

### 6.2 凭证存储

- 存储路径: `~/.ai-creator/credentials/{platform}/{account_id}.enc`
- 加密方式: AES-256-GCM
- 包含内容: cookies, storage_state, extra

---

## 七、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 平台反爬检测 | 登录/发布失败 | 使用指纹伪装、控制操作频率 |
| browser-use AI 理解错误 | 发布失败 | 提供详细任务描述、增加重试机制 |
| 凭证过期 | 需要重新登录 | 定期检测状态、提前提醒用户 |
| 平台 UI 变化 | 发布流程中断 | AI 自适应能力、及时更新任务描述 |

---

## 八、验收标准

### MVP 完成标准

1. [ ] 用户可以输入关键词获取 AI 推荐选题
2. [ ] 用户可以基于选题一键生成文章
3. [ ] 用户可以编辑 AI 生成的内容
4. [ ] 用户可以为文章生成配图
5. [ ] 用户可以通过扫码添加平台账号
6. [ ] 用户可以查看已绑定账号列表和状态
7. [ ] 用户可以选择平台和账号发布内容
8. [ ] 用户可以查看发布进度和结果
9. [ ] 发布失败时可以查看原因并重试
