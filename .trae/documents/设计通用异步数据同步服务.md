# 设计方案：通用异步数据同步服务

为了解决数据不一致问题并提供可扩展的同步能力，我将设计并实现一个通用的、后台运行的异步数据同步服务。

## 1. 核心架构设计

### 1.1 Rust 后端架构

在 `src-tauri/src` 下新增 `sync_service` 模块，包含以下组件：

- **`SyncEngine` (同步引擎)**: 核心调度器，负责管理不同数据类型的同步任务。
  - **触发机制**: 支持应用启动自动触发 (`auto_start`) 和前端手动触发 (`manual_trigger`)。
  - **任务队列**: 异步执行同步任务，避免阻塞主线程。
- **`SyncProvider` (同步提供者)**: 定义通用的 Trait，所有需要同步的数据类型（Project, PlatformAccount 等）都必须实现此接口。
  - `pull()`: 从云端拉取变更并更新本地。
  - `push()`: 将本地未同步的变更上传到云端。
- **`ApiClient` (API 客户端)**: 封装 `reqwest` 请求，统一处理认证、错误重试和 API 调用。

### 1.2 数据流向

- **Pull (云 -> 本地)**:
  1.  获取云端最新数据列表（带 `updated_at` 或版本号）。
  2.  对比本地数据：
      - 本地不存在 -> **Insert**
      - 本地存在但版本旧 -> **Update**
      - 本地存在但版本新（有未上传修改） -> **Conflict** (简单策略：以云端为准或保留本地副本)
- **Push (本地 -> 云)**:
  1.  查询本地 `sync_status = 'pending'` 的记录。
  2.  逐条（或批量）上传到云端。
  3.  上传成功后，更新本地 `sync_status = 'synced'` 和 `synced_at`。

## 2. 详细实现步骤

### 2.1 创建 `sync_service` 模块

- `mod.rs`: 模块入口及 `SyncState` 定义。
- `api_client.rs`: 封装 HTTP 请求，复用 `config.rs` 中的配置。
- `engine.rs`: 实现 `SyncEngine`，包含 `start_sync` 方法。
- `providers/mod.rs`: `SyncProvider` trait 定义。
- `providers/project.rs`: 项目同步逻辑实现。
- `providers/account.rs`: 平台账号同步逻辑实现。

### 2.2 实现 API Client

将 `commands/mod.rs` 中散落的 `reqwest` 调用逻辑抽取出来，形成统一的客户端，支持 `get_projects`, `sync_projects`, `get_accounts`, `sync_accounts` 等方法。

### 2.3 实现同步逻辑 (Provider)

- **ProjectProvider**:
  - Pull: 调用 `GET /projects`，遍历结果调用 `repo.sync_project` (已存在，需增强)。
  - Push: 查询 `sync_status='pending'` 的项目，调用 `POST/PUT /projects`。
- **AccountProvider**:
  - Pull: 调用 `GET /platform-accounts` (需确认 API)，遍历调用 `repo.create_platform_account` (需增强支持 upsert)。
  - Push: 主要是更新（如昵称变更），新建账号通常是先在云端/Sidecar 完成认证。

### 2.4 集成到 Tauri

- 在 `lib.rs` 的 `setup` 钩子中初始化 `SyncEngine`，并启动后台同步任务。
- 注册 Tauri 命令 `start_sync`，供前端手动调用。
- 注册 Tauri 命令 `get_sync_status`，供前端轮询或通过 Event 推送状态。

### 2.5 前端实现

- **设置页面**: 在 `apps/desktop/src/routes/settings/index.tsx` 添加“数据同步”卡片。
  - 显示“上次同步时间”。
  - 添加“立即同步”按钮，点击调用 `start_sync`。
  - 显示同步状态（旋转图标/进度条）。
- **Store 集成**: 同步完成后，发送事件通知前端 Store (`useProjectStore`, `useAccountStore`) 刷新数据。

## 3. 数据库变更

目前 `repository.rs` 中的 `sync_project` 等方法主要用于单向覆盖。需要增强为支持双向同步的 Upsert 逻辑（已在之前的任务中部分实现，需确认完善）。

## 4. 扩展性

该设计支持未来扩展 `ContentProvider` (文章同步) 和 `PublicationProvider` (发布任务同步)，只需实现 `SyncProvider` trait 并在 Engine 中注册即可。
